(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const o of document.querySelectorAll('link[rel="modulepreload"]'))s(o);new MutationObserver(o=>{for(const a of o)if(a.type==="childList")for(const i of a.addedNodes)i.tagName==="LINK"&&i.rel==="modulepreload"&&s(i)}).observe(document,{childList:!0,subtree:!0});function n(o){const a={};return o.integrity&&(a.integrity=o.integrity),o.referrerPolicy&&(a.referrerPolicy=o.referrerPolicy),o.crossOrigin==="use-credentials"?a.credentials="include":o.crossOrigin==="anonymous"?a.credentials="omit":a.credentials="same-origin",a}function s(o){if(o.ep)return;o.ep=!0;const a=n(o);fetch(o.href,a)}})();const A=[{id:"2025010001091",name:"LAKSHDEEP SINGH",father:"MANDEEP SINGH",class_group_no:"G1",lab_group_no:"G1"},{id:"2025010000690",name:"MALHAR ARORA",father:"RAJESH ARORA",class_group_no:"G1",lab_group_no:"G1"},{id:"2024010017022",name:"MANASVI",father:"RAJ KUMAR",class_group_no:"G1",lab_group_no:"G1"},{id:"2025010002576",name:"MANJOT KAUR",father:"JARNAIL SINGH",class_group_no:"G1",lab_group_no:"G1"},{id:"2025010002655",name:"MANJOT SINGH",father:"GURMAIL SINGH",class_group_no:"G1",lab_group_no:"G1"},{id:"2025010012344",name:"MANPAWAN KAUR",father:"PHULPREET SINGH",class_group_no:"G1",lab_group_no:"G1"},{id:"2025010010100",name:"MANPREET KUMAR",father:"SURESH KUMAR DHIR",class_group_no:"G1",lab_group_no:"G1"},{id:"2025010000791",name:"MANRAJDEEP SINGH",father:"HARDEEP SINGH",class_group_no:"G1",lab_group_no:"G1"},{id:"2024010149119",name:"MANTHAN ATTRI",father:"RAKESH KUMAR",class_group_no:"G1",lab_group_no:"G1"},{id:"2025010002828",name:"MANTHAN SHARMA",father:"RAMESH KUMAR",class_group_no:"G1",lab_group_no:"G1"},{id:"2025010002081",name:"MEHAK GUPTA",father:"ARUN GUPTA",class_group_no:"G1",lab_group_no:"G1"},{id:"2024010012927",name:"MEHAK PADWAL",father:"AJIT SINGH",class_group_no:"G1",lab_group_no:"G1"},{id:"2025010005777",name:"MEHAKDEEP KAUR",father:"DALBIR SINGH",class_group_no:"G1",lab_group_no:"G1"},{id:"2025010002630",name:"MEHAKPREET SINGH",father:"JASMEET SINGH",class_group_no:"G1",lab_group_no:"G1"},{id:"2025010000318",name:"MEHAR JOLLY",father:"DUSHYANT JOLLY",class_group_no:"G1",lab_group_no:"G1"},{id:"2025010002210",name:"MISHTHI",father:"SAMRAT KHANNA",class_group_no:"G1",lab_group_no:"G1"},{id:"2025010003062",name:"MITHILESHWAR",father:"ANIL KUMAR SHARMA",class_group_no:"G1",lab_group_no:"G1"},{id:"2025010000134",name:"MOHIT",father:"TILAK RAJ",class_group_no:"G1",lab_group_no:"G1"},{id:"2025010007933",name:"MOHIT SALWAN",father:"RAJINDER KUMAR",class_group_no:"G1",lab_group_no:"G1"},{id:"2025010014787",name:"MOHIT SINGH",father:"RACHPAL SINGH",class_group_no:"G1",lab_group_no:"G1"},{id:"2025010000548",name:"MOULIK YADAV",father:"VIKAS YADAV",class_group_no:"G1",lab_group_no:"G1"},{id:"2025010002913",name:"MRIDULA",father:"ANIL KUMAR",class_group_no:"G1",lab_group_no:"G1"},{id:"2025010001166",name:"MUSKAN",father:"MUNISH SINGAL",class_group_no:"G1",lab_group_no:"G1"},{id:"2025010000256",name:"NANDANI GARG",father:"RAKESH GARG",class_group_no:"G1",lab_group_no:"G1"},{id:"2025010002170",name:"NANDINI RATHORE",father:"PARMENDER SINGH THAKUR",class_group_no:"G1",lab_group_no:"G1"},{id:"2025010015257",name:"NAVDEEP KAUR",father:"SURINDERPAL SINGH",class_group_no:"G1",lab_group_no:"G1"},{id:"2025010005696",name:"NAVJIT KAPIL",father:"DARSHAN SINGH",class_group_no:"G1",lab_group_no:"G1"},{id:"2025010000174",name:"NAVJOT KAUR",father:"SUKHJINDER SINGH",class_group_no:"G1",lab_group_no:"G1"},{id:"2025010011633",name:"NAVNEET KAUR",father:"SURJIT SINGH",class_group_no:"G1",lab_group_no:"G1"},{id:"2025010013293",name:"NAVREET KAUR",father:"GURCHARAN SINGH",class_group_no:"G1",lab_group_no:"G1"},{id:"2025010005662",name:"NAVYA",father:"ANKUR UMAT",class_group_no:"G1",lab_group_no:"G1"},{id:"2025010001449",name:"NEELESH KALIA",father:"SAT PAUL",class_group_no:"G1",lab_group_no:"G1"},{id:"2025010007705",name:"NIMISH SURI",father:"MANAV SURI",class_group_no:"G1",lab_group_no:"G1"},{id:"2025010015387",name:"NIRJALA",father:"YOUDHVIR SINGH",class_group_no:"G1",lab_group_no:"G1"},{id:"2025010004261",name:"NITISH",father:"SANJEEV KUMAR",class_group_no:"G1",lab_group_no:"G1"},{id:"2025010013506",name:"PALAK SHARMA",father:"BALRAM SINGH",class_group_no:"G1",lab_group_no:"G1"},{id:"2025010012827",name:"PAVITERPREET SINGH",father:"BALKARAN SINGH",class_group_no:"G1",lab_group_no:"G1"},{id:"2025010001990",name:"PAVNEET SINGH",father:"JATINDER SINGH",class_group_no:"G1",lab_group_no:"G1"},{id:"2025010003616",name:"PRABHNOOR KAUR",father:"GURBHEJ SINGH",class_group_no:"G1",lab_group_no:"G2"},{id:"2025010010754",name:"PRABHNOOR SINGH",father:"AVTAR SINGH",class_group_no:"G1",lab_group_no:"G2"},{id:"2025010011756",name:"PRANAV JOSHI",father:"PARVEEN KUMAR",class_group_no:"G1",lab_group_no:"G2"},{id:"2025010002521",name:"PRINCE KUMAR",father:"TUNTUN KUMAR",class_group_no:"G1",lab_group_no:"G2"},{id:"2025010012252",name:"PRITIKA",father:"JOGINDER PAL",class_group_no:"G1",lab_group_no:"G2"},{id:"2025010006991",name:"PRIYANSHI",father:"KAMAL SINGH",class_group_no:"G1",lab_group_no:"G2"},{id:"2025010000782",name:"RAGHAV SHARMA",father:"MANOJ KUMAR SHARMA",class_group_no:"G1",lab_group_no:"G2"},{id:"2025010001824",name:"RAHUL SHARMA",father:"RAMESH KUMAR SHARMA",class_group_no:"G1",lab_group_no:"G2"},{id:"2025010007141",name:"RANVIR SINGH",father:"RANJODH SINGH",class_group_no:"G1",lab_group_no:"G2"},{id:"2025010014793",name:"RASHMITA",father:"SUKHBIR SINGH",class_group_no:"G1",lab_group_no:"G2"},{id:"2025010006422",name:"RAVDEEP KAUR",father:"SUKHCHAIN SINGH",class_group_no:"G1",lab_group_no:"G2"},{id:"2025010015608",name:"RAYAN CHANDEL",father:"PANKAJ KUMAR",class_group_no:"G1",lab_group_no:"G2"},{id:"2025010003151",name:"REHAN SINGH",father:"RAJINDER SINGH",class_group_no:"G1",lab_group_no:"G2"},{id:"2025010009937",name:"RIDHAMPREET SINGH ARORA",father:"AMANDEEP SINGH ARORA",class_group_no:"G1",lab_group_no:"G2"},{id:"2025010015803",name:"RISHITA",father:"JAI SIKANDER",class_group_no:"G1",lab_group_no:"G2"},{id:"2025010015872",name:"RIVANSHU BEHAL",father:"RAJAN BEHAL",class_group_no:"G1",lab_group_no:"G2"},{id:"2025010001216",name:"ROHINI SHARMA",father:"RAKESH KUMAR SHARMA",class_group_no:"G1",lab_group_no:"G2"},{id:"2025010013653",name:"ROHIT KUMAR",father:"AJIT RAM",class_group_no:"G1",lab_group_no:"G2"},{id:"2025010004822",name:"ROOPANSHI SHARMA",father:"SANDEEP SHARMA",class_group_no:"G1",lab_group_no:"G2"},{id:"2025010006224",name:"RUDRAKSH MEHRA",father:"RAMAN KUMAR",class_group_no:"G1",lab_group_no:"G2"},{id:"2025010012621",name:"RUDRAKSH SHARMA",father:"NARESH SHARMA",class_group_no:"G2",lab_group_no:"G2"},{id:"2025010013723",name:"RUHI",father:"KARNAIL SINGH",class_group_no:"G2",lab_group_no:"G2"},{id:"2025010006410",name:"SACHIN KUMAR BHAGAT",father:"PREM KUMAR BHAGAT",class_group_no:"G2",lab_group_no:"G2"},{id:"2025010016050",name:"SAHEJVEER SINGH",father:"HARJIT SINGH",class_group_no:"G2",lab_group_no:"G2"},{id:"2024010149114",name:"SAHIBPREET SINGH",father:"RAMESH CHANDER SINGH",class_group_no:"G2",lab_group_no:"G2"},{id:"2025010014956",name:"SAHIL GUPTA",father:"HARDEEP GUPTA",class_group_no:"G2",lab_group_no:"G2"},{id:"2025010004367",name:"SAKSHAM GUPTA",father:"RAKESH GUPTA",class_group_no:"G2",lab_group_no:"G2"},{id:"2025010003170",name:"SAKSHAM RATHOR",father:"VIKRANT SINGH",class_group_no:"G1",lab_group_no:"G1"},{id:"2025010003974",name:"SAMAIRA",father:"RAMAN KUMAR",class_group_no:"G2",lab_group_no:"G2"},{id:"2025010001134",name:"SAMRIDHI SHARMA",father:"SANJEEV KUMAR",class_group_no:"G2",lab_group_no:"G2"},{id:"2025010006202",name:"SANCHI SHARMA",father:"KAPIL SHARMA",class_group_no:"G2",lab_group_no:"G2"},{id:"2025010000040",name:"SANYAM GAUTAM",father:"PARVEEN KUMAR",class_group_no:"G2",lab_group_no:"G2"},{id:"2025010001393",name:"SATYAK GUPTA",father:"VIKAS GUPTA",class_group_no:"G2",lab_group_no:"G2"},{id:"2025010012011",name:"SAWAL PUSHKARNA",father:"SUSHIL PUSHKARNA",class_group_no:"G2",lab_group_no:"G2"},{id:"2025010015232",name:"SAWNI",father:"DEEPAK MEHTA",class_group_no:"G2",lab_group_no:"G2"},{id:"2025010005079",name:"SHAGUN KAUR CHAHAL",father:"RAJEEV SINGH",class_group_no:"G2",lab_group_no:"G2"},{id:"2025010011577",name:"SHASHANK SHEKHAR SOLANKI",father:"SANJEET KUMAR",class_group_no:"G2",lab_group_no:"G2"},{id:"2025010005778",name:"SHAURYA THAKUR",father:"DEEPAK SINGH THAKUR",class_group_no:"G2",lab_group_no:"G2"},{id:"2025010004908",name:"SHIVANG GUPTA",father:"VIJAY KUMAR",class_group_no:"G2",lab_group_no:"G3"},{id:"2025010003077",name:"SHIVANSH SHUKLA",father:"SUDHIR SHUKLA",class_group_no:"G2",lab_group_no:"G3"},{id:"2025010001215",name:"SHIVJOT SINGH",father:"VIJAY SINGH BHUNDPAL",class_group_no:"G2",lab_group_no:"G3"},{id:"2025010001020",name:"SHREYANSH BHARGAV",father:"RAJ KUMAR SINGH",class_group_no:"G2",lab_group_no:"G3"},{id:"2025010007912",name:"SIDARTH ATTRI",father:"RAJESH KUMAR",class_group_no:"G2",lab_group_no:"G3"},{id:"2025010004098",name:"SIRTAJ SINGH",father:"BALWINDER SINGH",class_group_no:"G2",lab_group_no:"G3"},{id:"2025010013820",name:"SIYA",father:"RAKESH KUMAR",class_group_no:"G2",lab_group_no:"G3"},{id:"2025010004303",name:"SOURAV",father:"RAMAN KUMAR",class_group_no:"G2",lab_group_no:"G3"},{id:"2025010005215",name:"SUKHMANI",father:"RAJ KUMAR",class_group_no:"G2",lab_group_no:"G3"},{id:"2025010004104",name:"SUKHMANJEET SINGH",father:"PARAMJEET SINGH",class_group_no:"G2",lab_group_no:"G3"},{id:"2025010014755",name:"SUKHMANPREET KAUR",father:"MANJINDER SINGH",class_group_no:"G2",lab_group_no:"G3"},{id:"2025010001761",name:"SUKHPAL SINGH",father:"BALWINDER SINGH",class_group_no:"G2",lab_group_no:"G3"},{id:"2025010013996",name:"SUNAKSHI MEHTA",father:"NEERAJ KUMAR MEHTA",class_group_no:"G2",lab_group_no:"G3"},{id:"2025010015464",name:"SUNDRAM KUMAR",father:"LAL BABU CHOUDRY",class_group_no:"G2",lab_group_no:"G3"},{id:"2025010001933",name:"SUNIDHI SOOD",father:"VISHAL SOOD",class_group_no:"G2",lab_group_no:"G3"},{id:"2025010014888",name:"SURYA DEY",father:"SUDIP DEY",class_group_no:"G2",lab_group_no:"G3"},{id:"2025010003288",name:"SUSHANK BALHOTRA",father:"SUKHWANT PAL",class_group_no:"G2",lab_group_no:"G3"},{id:"2025010008169",name:"SUSHEN GUPTA",father:"RAKESH KUMAR GUPTA",class_group_no:"G2",lab_group_no:"G3"},{id:"2025010032316",name:"TANDRIKA RANI",father:"RATHINDRO NATH KUNDU",class_group_no:"G2",lab_group_no:"G3"},{id:"2025010003334",name:"TANMYA MAHAJAN",father:"MANOJ KUMAR",class_group_no:"G2",lab_group_no:"G3"},{id:"2025010006879",name:"TEJAL CHOPRA",father:"DINESH CHOPRA",class_group_no:"G2",lab_group_no:"G3"},{id:"2025010008350",name:"TRIBHUVAN SINGH SENGAR",father:"MANVENDRA SINGH",class_group_no:"G2",lab_group_no:"G3"},{id:"2025010011718",name:"TUSHAAR",father:"RAJESH",class_group_no:"G2",lab_group_no:"G3"},{id:"2025010007466",name:"UJWAL",father:"BIKRAMJIT",class_group_no:"G2",lab_group_no:"G3"},{id:"2024010013164",name:"UTTAMPREET KAUR",father:"KULJIT SINGH",class_group_no:"G2",lab_group_no:"G3"},{id:"2025010009626",name:"VAIBHAV MAHAJAN",father:"AMIT MAHAJAN",class_group_no:"G2",lab_group_no:"G3"},{id:"2025010001634",name:"VAISHALI KUNDAL",father:"SURINDER KUMAR",class_group_no:"G2",lab_group_no:"G3"},{id:"2025010014996",name:"VARENYA MAHAJAN",father:"MANISH MAHAJAN",class_group_no:"G2",lab_group_no:"G3"},{id:"2025010001766",name:"VARUN ALOONA",father:"AJAY KUMAR",class_group_no:"G2",lab_group_no:"G3"},{id:"2025010015149",name:"VENU GOPAL SHARMA",father:"SUMIT SHARMA",class_group_no:"G2",lab_group_no:"G3"},{id:"2025010007238",name:"VINEET KUMAR",father:"BALTEJ KUMAR",class_group_no:"G2",lab_group_no:"G3"},{id:"2024010003797",name:"VINOD PARMAR",father:"VIJAY KUMAR",class_group_no:"G2",lab_group_no:"G3"},{id:"2025010009078",name:"VISHAL CHOUDHARY",father:"ASHOK KUMAR",class_group_no:"G2",lab_group_no:"G3"},{id:"2025010005793",name:"VISHESH KUMAR",father:"RAJESH KUMAR",class_group_no:"G2",lab_group_no:"G3"},{id:"2025010000492",name:"YASHIKA",father:"SONI SALARIA",class_group_no:"G2",lab_group_no:"G3"},{id:"2025010010003",name:"YOGITA",father:"RAJ KUMAR",class_group_no:"G2",lab_group_no:"G3"},{id:"2025010007860",name:"YUVRAJ JASSI",father:"HARJINDER KUMAR JASSI",class_group_no:"G2",lab_group_no:"G3"},{id:"17032400065",name:"JATIN",father:"SUBHASH CHANDER",class_group_no:"G2",lab_group_no:"G3"}],Re={apiKey:"AIzaSyCcn9HfE4RGoyNzR6pVJ9Lihg2jRXrRup8",authDomain:"gndu-attendance-system.firebaseapp.com",projectId:"gndu-attendance-system",storageBucket:"gndu-attendance-system.firebasestorage.app",messagingSenderId:"874240831454",appId:"1:874240831454:web:aaaa1909d87d9a77e0f74f",measurementId:"G-7TNPBZ3ZZN"},He=31.634801,Pe=74.824416,Ze=200,Fe=1e3,_t=3e4;async function Nt(){try{const e=await vt(),t=e.coords.latitude,n=e.coords.longitude,s=e.coords.accuracy;if(s>Fe)throw new Error(`GPS accuracy too low: ${Math.round(s)}m (required: ${Fe}m)`);const o=bt(t,n,He,Pe),i={success:o<=Ze,distance:Math.round(o),accuracy:Math.round(s),userLat:t,userLng:n,timestamp:Date.now(),timezone:Intl.DateTimeFormat().resolvedOptions().timeZone,userAgent:navigator.userAgent.substring(0,100),address:"Location verification simplified"};return tt(i),i}catch(e){throw new Error(`Location verification failed: ${e.message}`)}}function vt(){return new Promise((e,t)=>{if(!navigator.geolocation){t(new Error("Geolocation not supported by this browser"));return}navigator.onLine||console.warn("Device appears to be offline, location might fail");const n={enableHighAccuracy:!0,timeout:5e3,maximumAge:_t},s=new Promise((a,i)=>{setTimeout(()=>{i(new Error("Location request timed out (forced)"))},6e3)}),o=new Promise((a,i)=>{navigator.geolocation.getCurrentPosition(r=>{if(!r.coords||typeof r.coords.latitude!="number"||typeof r.coords.longitude!="number"){i(new Error("Invalid location data received"));return}if(r.coords.latitude===0&&r.coords.longitude===0){i(new Error("Invalid coordinates detected"));return}a(r)},r=>{let c="Location access failed";switch(r.code){case r.PERMISSION_DENIED:c="Location permission denied. Please enable location access.";break;case r.POSITION_UNAVAILABLE:c="Location unavailable. Please check GPS settings.";break;case r.TIMEOUT:c="Location request timed out.";break}i(new Error(c))},n)});Promise.race([o,s]).then(e).catch(t)})}let Ke=0,Rt=0;window.showLocationPerformance=function(){if(typeof locationManager>"u"){console.log("Location system not initialized");return}const e=locationManager.getPerformanceMetrics();console.log("üìç Location System Performance"),console.log("=============================="),console.log(`Total Requests: ${e.totalRequests}`),console.log(`Success Rate: ${e.successRate}%`),console.log(`Cache Hit Rate: ${e.cacheHitRate}%`),console.log(`Errors: ${e.errors}`)};let S,D=!1,K,C=null,re=null,N={},v={},p=null,Z="",le="";function Gt(e){const t=window.location.href.split("?")[0];return window.location.hostname==="localhost"||window.location.hostname==="127.0.0.1"||window.location.hostname.includes("127.0.0.1")?t.replace(/\/$/,"")+"/index.html?session="+e:t+"?session="+e}document.addEventListener("DOMContentLoaded",function(){const e=new URLSearchParams(window.location.search),t=e.get("session"),n=e.get("view");t?(document.getElementById("loginScreen").style.display="none",document.getElementById("teacherDashboard").style.display="none",document.getElementById("studentCheckin").style.display="block",we(t)):n==="student"?(window.history.replaceState&&window.history.replaceState({},document.title,window.location.pathname),de()):localStorage.getItem("guestMode")==="true"?st():localStorage.getItem("user")?de():nt(),Xe().then(()=>new Promise(s=>{const o=K.onAuthStateChanged(a=>{a?(localStorage.setItem("user",JSON.stringify({email:a.email,uid:a.uid,displayName:a.displayName})),Dt(a)):localStorage.removeItem("user"),o&&o(),s(a)})})).then(()=>et()).catch(s=>{if(t){const o=JSON.parse(localStorage.getItem("attendanceSession_"+t)||"null");o&&z(o)?(document.getElementById("loginScreen").style.display="none",document.getElementById("teacherDashboard").style.display="none",document.getElementById("studentCheckin").style.display="block",ce()):(document.getElementById("loginScreen").style.display="none",document.getElementById("teacherDashboard").style.display="none",document.getElementById("studentCheckin").style.display="block",we(t))}else n==="student"&&(document.getElementById("loginScreen").style.display="none",document.getElementById("teacherDashboard").style.display="none",document.getElementById("studentCheckin").style.display="none",document.getElementById("studentDetails").style.display="block",Ie().catch(()=>{}))})});let P=null,O=!0,X=null;function Xe(){return new Promise((e,t)=>{try{const s=["apiKey","authDomain","projectId","appId"].filter(o=>!Re||!Re[o]);if(s.length)return V("üî¥ Firebase config is missing. Please configure env.js","error"),t(new Error("Missing Firebase config: "+s.join(", ")));firebase.initializeApp(Re),S=firebase.firestore(),K=firebase.auth(),K.setPersistence(firebase.auth.Auth.Persistence.LOCAL).then(()=>S.enablePersistence({experimentalForceOwningTab:!0})).then(()=>S.enableNetwork().catch(o=>{V("‚ö†Ô∏è Working in offline mode","warning")})).then(()=>{D=!0,V("üü¢ Connected to Firebase","connected"),e()}).catch(o=>{o.code==="failed-precondition"||o.code,D=!0,V("‚ö†Ô∏è Limited offline functionality","warning"),e()})}catch(n){V("üî¥ Failed to connect to Firebase","error"),t(n)}})}let ge=!1;async function et(){if(!(ge||A.length>0)){ge=!0;try{if(!S){ge=!1;return}const e=await S.collection("students").orderBy("name").get({source:"server"});A.length=0;const t=[];e.docs.forEach(o=>{try{const a=o.data();a&&a.id&&t.push({id:a.id,name:a.name||"",father:a.father||"",class_group_no:a.class_group_no||0,lab_group_no:a.lab_group_no||0})}catch{}});const n=t.findIndex(o=>o.id==="17032400065");if(n!==-1){const o=t.splice(n,1)[0];t.push(o)}A.push(...t);const s=document.getElementById("loadingMessage");s&&(s.style.display="none"),document.getElementById("startBtn")&&te()}catch{V("üî¥ Failed to load students from Firestore","error")}finally{ge=!1}}}const Je=new Map,Ct=3e4,pe=new Map;function tt(e){try{const t=JSON.parse(localStorage.getItem("locationAttempts")||"[]");t.length>=10&&t.shift(),t.push({...e,timestamp:Date.now()}),localStorage.setItem("locationAttempts",JSON.stringify(t))}catch(t){console.warn("Failed to store location attempt:",t)}}function Tt(e,t,n){const s=[{lat:0,lng:0},{lat:37.7749,lng:-122.4194},{lat:40.7128,lng:-74.006},{lat:51.5074,lng:-.1278}];for(const o of s)if(Math.abs(e-o.lat)<1e-4&&Math.abs(t-o.lng)<1e-4)throw new Error("Suspicious location detected");return n<1&&console.warn("Unusually high GPS accuracy detected:",n),!0}window.getLocationHistory=function(){const e=JSON.parse(localStorage.getItem("locationAttempts")||"[]");return console.table(e),e};window.testGeoapifyIntegration=async function(){console.log("üß™ Testing Geoapify Integration...");const e=getGeoapifyConfig();if(console.log("üìã Configuration:",e),!e.apiKey||e.apiKey==="YOUR_GEOAPIFY_API_KEY"){console.error("‚ùå Geoapify API key not configured");return}try{console.log("üåê Testing IP geolocation...");const t=await getGeoapifyIPLocation();console.log("‚úÖ IP Location:",t),console.log("üîç Testing reverse geocoding...");const n=await verifyLocationWithGeoapify(He,Pe);console.log("‚úÖ University Address:",n),console.log("üìç Testing full location verification...");const s=await St();console.log("‚úÖ Location Verification Result:",s),console.log("üéâ All Geoapify tests completed successfully!")}catch(t){console.error("‚ùå Geoapify test failed:",t)}};window.showCurrentLocationDetails=async function(){try{console.log("üìç Getting current location details...");const e=await getCurrentPositionWithGeoapify();console.log("üéØ GPS Position:",{latitude:e.coords.latitude,longitude:e.coords.longitude,accuracy:e.coords.accuracy}),e.ipLocation&&console.log("üåê IP Location:",e.ipLocation);const t=await verifyLocationWithGeoapify(e.coords.latitude,e.coords.longitude);console.log("üîç Address Verification:",t);const n=bt(e.coords.latitude,e.coords.longitude,He,Pe);console.log("üìè Distance to University:",Math.round(n)+"m")}catch(e){console.error("‚ùå Failed to get location details:",e)}};async function Lt(e){const t=`session_${e}`,n=Je.get(t);if(n&&Date.now()-n.timestamp<Ct)return console.log("Using cached session data"),n.data;if(pe.has(t))return console.log("Waiting for existing session request"),pe.get(t);const s=(async()=>{try{console.log("Fetching fresh session data from Firebase");const o=await S.collection("attendanceSessions").doc(e).get();if(o.exists){const a=o.data();return a.expiryTime&&typeof a.expiryTime.toDate=="function"?a.expiryTime=a.expiryTime.toDate().toISOString():a.expiryTime&&typeof a.expiryTime.seconds=="number"&&(a.expiryTime=new Date(a.expiryTime.seconds*1e3).toISOString()),Je.set(t,{data:a,timestamp:Date.now()}),localStorage.setItem("attendanceSession_"+e,JSON.stringify(a)),a}else throw new Error("Session not found")}finally{pe.delete(t)}})();return pe.set(t,s),s}const xt={Monday:{"09:00-09:55":{MTL1001:"Dr. Ramandeep Kaur"},"10:00-10:55":{PBL1021:"Mr. Saraj"},"11:00-11:55":{PHL1083:"Dr. Vaishali"},"12:00-12:55":{CEL1020:"Sahil Sharma"},"02:00-02:55":{CEL1020:"Sahil Sharma"},"03:00-03:55":{PBL1022:"Dr. Kanwaljit Kaur",HSL4000:"NTB"}},Tuesday:{"09:00-09:55":{MTL1001:"Dr. Ramandeep Kaur"},"10:00-10:55":{PHL1083:"Dr. Vaishali"},"11:00-11:55":{MEL1021:"Er. Satnam Singh"},"12:00-12:55":{CEL1020:"Sahil Sharma"}},Wednesday:{"09:00-09:55":{MEL1021:"Er. Satnam Singh"},"10:00-10:55":{PBL1021:"Mr. Saraj"},"11:00-11:55":{PHL1083:"Dr. Vaishali"},"02:00-02:55":{CEL1020:"Sahil Sharma"},"03:00-03:55":{MTL1001:"Dr. Ramandeep Kaur"},"04:00-04:55":{MTL1001:"Dr. Ramandeep Kaur"}},Thursday:{"09:00-09:55":{MEL1021:"Er. Satnam Singh"},"10:00-10:55":{MTL1001:"Dr. Ramandeep Kaur"},"11:00-11:55":{MEL1021:"Er. Satnam Singh"}},Friday:{"09:00-09:55":{MEL1021:"Er. Satnam Singh"},"10:00-10:55":{CEL1020:"Sahil Sharma"},"11:00-11:55":{MEL1021:"Er. Satnam Singh"},"03:00-03:55":{PBL1022:"Dr. Kanwaljit Kaur",HSL4000:"NTB"}}},Be={CEL1020:"Engineering Mechanics",MEL1021:"Engineering Graphics & Drafting",MTL1001:"Mathematics I",PHL1083:"Physics",PBL1021:"Punjabi (Compulsory)",PBL1022:"Basic Punjabi",HSL4000:"Punjab History & Culture"};window.handleLogin=async function(){var o,a,i;if(!K){alert("Authentication service is not ready. Please refresh the page.");return}const e=(a=(o=document.getElementById("loginEmail"))==null?void 0:o.value)==null?void 0:a.trim(),t=(i=document.getElementById("loginPassword"))==null?void 0:i.value,n=document.getElementById("loginMessage"),s=document.getElementById("loginBtn");if(!e||!t){n&&j(n,"error","Please enter both email and password");return}s&&(s.disabled=!0,s.textContent="Signing in..."),n&&fe(n);try{const c=(await K.signInWithEmailAndPassword(e,t)).user;n&&j(n,"success","‚úÖ Login successful! Redirecting..."),de()}catch(r){let c="Login failed. Please try again.";switch(r.code){case"auth/user-not-found":c="No user found with this email.";break;case"auth/wrong-password":c="Incorrect password. Please try again.";break;case"auth/invalid-email":c="Invalid email address format.";break;case"auth/user-disabled":c="This account has been disabled.";break;case"auth/too-many-requests":c="Too many failed attempts. Please try again later.";break;default:c=r.message||"Login failed. Please try again.";break}j(n,"error",`‚ùå ${c}`),s.disabled=!1,s.textContent="Login"}};async function Ue(){if(confirm("Are you sure you want to logout?"))try{localStorage.getItem("guestMode")==="true"||await K.signOut(),localStorage.removeItem("guestMode"),localStorage.removeItem("userType"),C=null,p=null,N={},v={},document.getElementById("loginEmail").value="",document.getElementById("loginPassword").value="",document.getElementById("loginMessage").innerHTML="";const t=document.querySelector(".login-header h1");t&&(t.textContent="üîê Secure Login"),document.getElementById("loginScreen").style.display="flex",document.getElementById("teacherDashboard").style.display="none",document.getElementById("studentGuestDashboard").style.display="none",document.getElementById("studentCheckin").style.display="none";const n=document.getElementById("firebaseStatus");n&&(n.textContent="üîÑ Connecting to Firebase...")}catch{alert("Error signing out. Please try again.")}}function nt(){if(!new URLSearchParams(window.location.search).get("session")){document.getElementById("loginScreen").style.display="flex",document.getElementById("teacherDashboard").style.display="none",document.getElementById("studentCheckin").style.display="none";const n=document.getElementById("studentDetailsModal");n&&(n.style.display="none"),document.body.classList.remove("modal-open"),document.body.classList.remove("dashboard-view","student-checkin-page"),document.body.classList.add("login-view")}}function de(){if(!new URLSearchParams(window.location.search).get("session")){document.getElementById("loginScreen").style.display="none",document.getElementById("teacherDashboard").style.display="block",document.getElementById("studentCheckin").style.display="none";const n=document.getElementById("studentDetailsModal");n&&(n.style.display="none"),document.body.classList.remove("modal-open"),document.body.classList.remove("login-view","student-checkin-page"),document.body.classList.add("dashboard-view"),window.history.replaceState&&window.history.replaceState({},document.title,window.location.pathname)}}function Dt(e){const t=new URLSearchParams(window.location.search),n=t.get("session"),s=t.get("view");if(n){we(n);return}if(s==="student"){document.body.classList.contains("modal-open")?(document.getElementById("studentDetailsModal").style.display="flex",Ie().catch(()=>{})):de();return}e?de():nt()}function ot(){localStorage.setItem("guestMode","true"),localStorage.setItem("userType","student"),st(),Mt()}function st(){document.getElementById("loginScreen").style.display="none",document.getElementById("teacherDashboard").style.display="none",document.getElementById("studentGuestDashboard").style.display="block",document.getElementById("studentCheckin").style.display="none",document.body.classList.remove("login-view","student-checkin-page","dashboard-view"),document.body.classList.add("guest-dashboard-view"),Bt()}function Bt(){const e=document.getElementById("guestSearch");e&&e.addEventListener("input",Ft);const t=document.getElementById("guestPrintBtn");t&&t.addEventListener("click",Jt);const n=document.getElementById("guestExportBtn");n&&n.addEventListener("click",Vt),kt(),Pt(),window.debugAttendanceSessions=async function(s=null){try{if(!S||!D){console.log("Database not available");return}let o=s;if(s&&s.includes("-")){const r=s.split("-");r.length===3&&(o=`${r[2]}/${r[1]}/${r[0]}`,console.log(`Converting date: ${s} -> ${o}`))}let a=S.collection("attendanceSessions");o&&(a=a.where("date","==",o));const i=await a.get();return console.log(`Found ${i.size} sessions${o?` for date ${o}`:""}`),i.forEach(r=>{const c=r.data();console.log("Session:",{id:r.id,date:c.date,subjectCode:c.subjectCode,subjectName:c.subjectName,subject:c.subject,timeSlot:c.timeSlot,teacherName:c.teacherName})}),i.docs.map(r=>({id:r.id,...r.data()}))}catch(o){console.error("Error debugging sessions:",o)}},console.log('Guest dashboard initialized. Use debugAttendanceSessions("2025-09-01") in console to debug sessions.')}async function Mt(){}let U=null,F=!0,ee=null;function kt(){const e={guestHeaderRoll:"roll",guestHeaderId:"id",guestHeaderName:"name",guestHeaderFather:"father",guestHeaderStatus:"status",guestHeaderTime:"time"};Object.entries(e).forEach(([t,n])=>{const s=document.getElementById(t);s&&(s.dataset.originalText=s.textContent,s.addEventListener("click",function(){if(Object.keys(e).forEach(i=>{const r=document.getElementById(i);r&&(r.classList.remove("sorted"),r.textContent=r.dataset.originalText)}),n==="status")U!=="status"?(U="status",ee="presentFirst",s.textContent="Status (Present First)"):ee==="presentFirst"?(ee="absentFirst",s.textContent="Status (Absent First)"):(U=null,ee=null,s.textContent=s.dataset.originalText);else{U===n?F=!F:(U=n,F=!1,n!=="name"&&(F=!0)),ee=null;const i=F?" ‚ñ≤":" ‚ñº";s.textContent=s.dataset.originalText+i}U&&s.classList.add("sorted");const o=document.getElementById("guestDateSelect"),a=document.getElementById("guestSubjectSelect");o&&a&&o.value&&a.value&&me()}))})}function Ht(e,t,n){return U?U==="status"?e.sort((s,o)=>{const a=t[s.id]===!0,i=t[o.id]===!0;if(ee==="presentFirst"){if(a&&!i)return-1;if(!a&&i)return 1}else if(ee==="absentFirst"){if(!a&&i)return-1;if(a&&!i)return 1}return 0}):U==="time"?e.sort((s,o)=>{const a=n[s.id]||"",i=n[o.id]||"";return a===""&&i!==""?F?1:-1:i===""&&a!==""?F?-1:1:a===""&&i===""?0:F?a.localeCompare(i):i.localeCompare(a)}):U==="roll"?e.sort((s,o)=>{const a=J(s.id)||0,i=J(o.id)||0;return F?a-i:i-a}):e.sort($e(U,F)):e}function Pt(){const e=document.getElementById("closeStudentDetails");e&&e.addEventListener("click",be);const t=document.getElementById("studentDetailsModal");t&&t.addEventListener("click",function(n){n.target===t&&be()}),document.addEventListener("keydown",function(n){n.key==="Escape"&&document.getElementById("studentDetailsModal").style.display==="flex"&&be()})}function at(e){const t=A.find(s=>s.id===e);if(!t)return;document.getElementById("metaId").textContent=e,document.getElementById("studentDetailsName").textContent=t.name||`Student ${e}`,document.getElementById("metaFather").textContent=t.father||"-";const n=document.getElementById("studentDetailsModal");n.style.display="flex",document.body.classList.add("modal-open"),Ut(e)}function be(){const e=document.getElementById("studentDetailsModal");e.style.display="none",document.body.classList.remove("modal-open")}async function Ut(e){try{let t=function(f){return f?f.replace(/^[A-Z]{2,4}\d{4}\s*-\s*/i,"").trim()||f:"General"};if(!S||!D){document.getElementById("overall").textContent="Database unavailable";return}const s=(await S.collection("attendanceSessions").get()).docs.map(f=>({id:f.id,...f.data()}));if(s.length===0){document.getElementById("overall").textContent="0%",document.getElementById("totalSessions").textContent="0",document.getElementById("subjectList").innerHTML='<div class="subject-item">No sessions found</div>';return}const o=await ht(e,s),a=new Map(s.map(f=>[f.id,f])),i=new Map;let r=0;for(const f of o){const l=a.get(f.sessionId||f._sessionId),u=f.subjectName||l&&(l.subjectName||l.subject)||f.subjectCode||"General",g=t(u),h=i.get(g)||{total:0,present:0};h.present+=1,i.set(g,h),r+=1}const c=new Map;for(const f of s){const l=f.subjectName||f.subject||f.subjectCode||"General",u=t(l);c.set(u,(c.get(u)||0)+1)}for(const[f,l]of c.entries()){const u=i.get(f)||{total:0,present:0};u.total=l,i.set(f,u)}const d=s.length,m=d>0?Math.round(r/d*100):0;document.getElementById("overall").textContent=`${m}%`,document.getElementById("totalSessions").textContent=d;const b=document.getElementById("subjectList");if(b){b.innerHTML="";const f=Array.from(i.entries()).sort((l,u)=>String(l[0]).localeCompare(String(u[0])));for(const[l,u]of f){const g=document.createElement("div");g.className="subject-item";const h=document.createElement("div");h.innerHTML=`<span class="subject-name">${l}</span><br/><small>${u.present}/${u.total} present</small>`;const E=document.createElement("div"),_=document.createElement("span"),L=u.total>0?u.present/u.total:0;L>=.75?_.className="pill green":L>=.5?_.className="pill orange":_.className="pill red",_.textContent=u.total>0?Math.round(u.present/u.total*100)+"%":"0%",E.appendChild(_),g.appendChild(h),g.appendChild(E),b.appendChild(g)}}}catch(t){console.error("Error loading student details:",t),document.getElementById("overall").textContent="Error loading data"}}async function me(){const e=document.getElementById("guestDateSelect"),t=document.getElementById("guestSubjectSelect"),n=document.getElementById("guestSessionStatus"),s=e.value,o=t.value;if(console.log("=== GUEST ATTENDANCE LOAD START ==="),console.log("User selected:",{date:s,subject:o,subjectSelectElement:t,availableOptions:Array.from(t.options).map(a=>({value:a.value,text:a.text}))}),!s||!o){console.log("Missing date or subject, hiding content"),document.getElementById("guestStatsSection").style.display="none",document.getElementById("guestTableContainer").style.display="none",document.getElementById("guestScrollHint").style.display="none",n&&(n.style.display="none");return}try{if(!S||!D){ae("Database not available. Please check your connection.","error");return}ae("Loading attendance data...","info");const a=s.split("-"),i=`${a[2]}/${a[1]}/${a[0]}`;console.log(`Converting date: ${s} -> ${i}`);const r=Be[o]||o;console.log(`Searching for session: date=${i}, selectedSubject=${o}, subjectName=${r}`);let c=null;if(console.log(`Trying query 1: date=${i}, subjectCode=${o}`),c=await S.collection("attendanceSessions").where("date","==",i).where("subjectCode","==",o).get(),c.empty||console.log(`Strategy 1 found ${c.size} sessions`),c.empty&&(console.log(`Trying query 2: date=${i}, subjectName=${r}`),c=await S.collection("attendanceSessions").where("date","==",i).where("subjectName","==",r).get(),c.empty||console.log(`Strategy 2 found ${c.size} sessions`)),c.empty&&(console.log(`Trying query 3: date=${i}, subject=${o}`),c=await S.collection("attendanceSessions").where("date","==",i).where("subject","==",o).get(),c.empty||console.log(`Strategy 3 found ${c.size} sessions`)),c.empty&&(console.log(`Trying query 4: date=${i}, subject=${r}`),c=await S.collection("attendanceSessions").where("date","==",i).where("subject","==",r).get(),c.empty||console.log(`Strategy 4 found ${c.size} sessions`)),c.empty&&(console.log(`Trying query 5: date=${i}, manual filtering`),c=await S.collection("attendanceSessions").where("date","==",i).get(),!c.empty)){const y=[];c.forEach(R=>{const I=R.data(),ne=I.subjectCode||"",oe=I.subjectName||"",M=I.subject||"";ne===o||oe===r||M===o||M===r||ne.toLowerCase()===o.toLowerCase()||oe.toLowerCase()===r.toLowerCase()?(y.push(R),console.log(`Found matching session: ${ne||oe||M} matches ${o}`)):console.log(`Session ${ne||oe||M} does not match ${o}`)}),y.length>0?(c={empty:!1,docs:y},console.log(`Found ${y.length} matching sessions for subject ${o}`)):console.log(`No sessions found for subject ${o} on date ${i}`)}if(c.empty){console.log("No sessions found at all for date:",i),ae(`No attendance session found for ${o} on ${i}`,"error"),Ge();return}console.log(`Found ${c.docs.length} total sessions for date ${i}`),c.docs.forEach((y,R)=>{const I=y.data();console.log(`Session ${R+1}:`,{id:y.id,subjectCode:I.subjectCode,subjectName:I.subjectName,subject:I.subject,timeSlot:I.timeSlot,teacherName:I.teacherName,date:I.date})});const d=c.docs[0],m=d.data(),b=d.id;console.log("Selected session for verification:",{id:b,data:m});const f=m.subjectCode||"",l=m.subjectName||"",u=m.subject||"";console.log("VERIFICATION - Checking session match:",{selectedSubject:o,selectedSubjectName:r,sessionSubjectCode:f,sessionSubjectName:l,sessionSubject:u,fullSessionData:m});const g=f===o||u===o;if(console.log("VERIFICATION - Match result:",g),!g){console.warn("VERIFICATION FAILED - Session does not match selected subject",{selected:o,found:{subjectCode:f,subjectName:l,subject:u}}),ae(`No attendance session found for ${o} on ${i}`,"error"),Ge();return}console.log("VERIFICATION SUCCESS - Session matches selected subject");const h=await S.collection("attendanceSessions").doc(b).collection("attendance").get(),E={},_={};h.forEach(y=>{const R=y.data();E[y.id]=!0,_[y.id]=R.time||"Unknown"}),m.attendance&&Object.keys(m.attendance).forEach(y=>{m.attendance[y]===!0&&(E[y]=!0,_[y]||(_[y]="Present"))});const L=Be[o]||o,W=m.timeSlot||"Unknown Time",x=m.teacherName||"Unknown Teacher";ae(`Found session: ${L} - ${W} (Teacher: ${x})`,"success"),Ot(E,_),Kt(E),document.getElementById("guestStatsSection").style.display="grid",document.getElementById("guestTableContainer").style.display="block",document.getElementById("guestScrollHint").style.display="block"}catch(a){console.error("Error loading attendance:",a),ae("Failed to load attendance data. Please try again.","error"),Ge()}}function ae(e,t){const n=document.getElementById("guestSessionStatus");n&&(n.textContent=e,n.className=`session-status ${t}`,n.style.display="block")}function Ge(){document.getElementById("guestStatsSection").style.display="none",document.getElementById("guestTableContainer").style.display="none",document.getElementById("guestScrollHint").style.display="none"}async function $t(){console.log("=== DEBUG: Checking all attendance sessions ===");try{const e=await S.collection("attendanceSessions").get(),t={};return e.forEach(n=>{const s=n.data(),o=s.date;t[o]||(t[o]=[]),t[o].push({id:n.id,subjectCode:s.subjectCode,subjectName:s.subjectName,subject:s.subject,timeSlot:s.timeSlot,teacherName:s.teacherName})}),console.log("All sessions by date:",t),t}catch(e){console.error("Error debugging attendance data:",e)}}window.debugGuestAttendanceData=$t;async function jt(){me()}function Ot(e,t){const n=document.getElementById("guestStudentTable");if(!n)return;let s=it();s=Ht(s,e,t),n.innerHTML="",s.forEach(o=>{const a=document.createElement("tr");e[o.id]&&a.classList.add("present");const i=document.createElement("td");i.textContent=String(J(o.id));const r=document.createElement("td");r.textContent=String(o.id);const c=document.createElement("td"),d=document.createElement("button");d.className="name-link",d.textContent=String(o.name||""),d.onclick=()=>at(o.id),c.appendChild(d);const m=document.createElement("td");m.textContent=String(o.father||"");const b=document.createElement("td"),f=document.createElement("span");e[o.id]?(f.className="status-present",f.textContent="Present"):(f.className="status-absent",f.textContent="Absent"),b.appendChild(f);const l=document.createElement("td");l.textContent=t[o.id]?String(t[o.id]):"-",a.appendChild(i),a.appendChild(r),a.appendChild(c),a.appendChild(m),a.appendChild(b),a.appendChild(l),n.appendChild(a)})}function it(){var t;if(!A||!Array.isArray(A))return[];const e=((t=document.getElementById("guestSearch"))==null?void 0:t.value.toLowerCase())||"";return e?A.filter(n=>{const s=(n.name||"").toLowerCase(),o=(n.father||"").toLowerCase(),a=(n.id||"").toString().toLowerCase();return s.includes(e)||o.includes(e)||a.includes(e)}):A}function Ft(){const e=document.getElementById("guestDateSelect"),t=document.getElementById("guestSubjectSelect");e&&t&&e.value&&t.value&&me()}function Kt(e){const t=A||[],n=t.filter(i=>e[i.id]).length,s=t.length,o=s-n,a=s>0?Math.round(n/s*100):0;document.getElementById("guestTotalStudents").textContent=s,document.getElementById("guestPresentCount").textContent=n,document.getElementById("guestAbsentCount").textContent=o,document.getElementById("guestAttendancePercent").textContent=a+"%"}function Jt(){window.print()}async function Vt(){try{if(!window.ExcelJS){alert("ExcelJS library not loaded. Please check your internet connection and try again.");return}const e=document.getElementById("guestDateSelect"),t=document.getElementById("guestSubjectSelect");if(!e.value||!t.value){alert("Please select both date and subject first.");return}const n=e.value,s=t.value,o=t.options[t.selectedIndex].textContent,a=it(),i=new ExcelJS.Workbook,r=i.addWorksheet("Attendance");r.mergeCells("A1:F1"),r.getCell("A1").value="GNDU Attendance System - Guest View",r.getCell("A1").font={size:16,bold:!0},r.getCell("A1").alignment={vertical:"middle",horizontal:"center"},r.mergeCells("A2:F2"),r.getCell("A2").value=`Date: ${n} | Subject: ${o}`,r.getCell("A2").font={size:11,color:{argb:"FF555555"}},r.getCell("A2").alignment={vertical:"middle",horizontal:"center"};const c=["Roll Number","Student ID","Name","Father's Name","Status","Check-in Time"];r.getRow(4).values=c;const d=document.getElementById("guestStudentTable");d&&d.querySelectorAll("tr").forEach((g,h)=>{const E=g.querySelectorAll("td");if(E.length>=6){const _=h+5;r.getRow(_).values=[E[0].textContent.trim(),E[1].textContent.trim(),E[2].textContent.trim(),E[3].textContent.trim(),E[4].textContent.trim(),E[5].textContent.trim()]}}),r.getRow(4).font={bold:!0},r.getRow(4).fill={type:"pattern",pattern:"solid",fgColor:{argb:"FFE3F2FD"}},r.columns.forEach(u=>{u.width=15});const m=await i.xlsx.writeBuffer(),b=new Blob([m],{type:"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"}),f=URL.createObjectURL(b),l=document.createElement("a");l.href=f,l.download=`GNDU_Attendance_${n}_${s}.xlsx`,document.body.appendChild(l),l.click(),document.body.removeChild(l),URL.revokeObjectURL(f)}catch(e){console.error("Error exporting to Excel:",e),alert("Export failed. Please try again.")}}window.handleGuestLogin=ot;window.loadSelectedSession=jt;window.loadGuestAttendance=me;window.logout=Ue;window.openGuestStudentDetails=at;window.closeGuestStudentDetails=be;window.showTab=rt;window.showGuestTab=ct;window.showResourceTab=dt;window.showGuestResourceTab=ut;window.loadSubjectResources=mt;window.loadGuestSubjectResources=ft;window.addResource=gt;window.deleteResource=qt;function rt(e){const t=document.getElementById("attendanceSection"),n=document.getElementById("setupSection"),s=document.getElementById("resourcesSection"),o=document.getElementById("miscellaneousSection");if(document.querySelectorAll("#teacherDashboard .tab-btn").forEach(i=>i.classList.remove("active")),e==="attendance"){s&&(s.style.display="none"),o&&(o.style.display="none"),C&&p?(t&&(t.style.display="block"),n&&(n.style.display="none")):(t&&(t.style.display="none"),n&&(n.style.display="block"));const i=document.querySelector(`#teacherDashboard .tab-btn[onclick="showTab('attendance')"]`);i&&i.classList.add("active")}else if(e==="resources"){t&&(t.style.display="none"),n&&(n.style.display="none"),o&&(o.style.display="none"),s&&(s.style.display="block");const i=document.querySelector(`#teacherDashboard .tab-btn[onclick="showTab('resources')"]`);i&&i.classList.add("active")}else if(e==="miscellaneous"){t&&(t.style.display="none"),n&&(n.style.display="none"),s&&(s.style.display="none"),o&&(o.style.display="block");const i=document.querySelector(`#teacherDashboard .tab-btn[onclick="showTab('miscellaneous')"]`);i&&i.classList.add("active")}}function ct(e){const t=document.getElementById("guestAttendanceTab"),n=document.getElementById("guestResourcesTab"),s=document.getElementById("guestMiscellaneousTab");if(document.querySelectorAll("#studentGuestDashboard .tab-btn").forEach(a=>a.classList.remove("active")),e==="attendance"){t&&(t.style.display="block"),n&&(n.style.display="none"),s&&(s.style.display="none");const a=document.querySelector(`#studentGuestDashboard .tab-btn[onclick="showGuestTab('attendance')"]`);a&&a.classList.add("active")}else if(e==="resources"){t&&(t.style.display="none"),n&&(n.style.display="block"),s&&(s.style.display="none");const a=document.querySelector(`#studentGuestDashboard .tab-btn[onclick="showGuestTab('resources')"]`);a&&a.classList.add("active")}else if(e==="miscellaneous"){t&&(t.style.display="none"),n&&(n.style.display="none"),s&&(s.style.display="block");const a=document.querySelector(`#studentGuestDashboard .tab-btn[onclick="showGuestTab('miscellaneous')"]`);a&&a.classList.add("active")}}let $=null,lt="notes";function dt(e){lt=e;const t=document.getElementById("notesTab"),n=document.getElementById("pyqsTab"),s=document.getElementById("videosTab"),o=document.getElementById("booksTab");document.querySelectorAll(".resource-tab-btn").forEach(r=>r.classList.remove("active")),e==="notes"?(t&&(t.style.display="block"),n&&(n.style.display="none"),s&&(s.style.display="none"),o&&(o.style.display="none")):e==="pyqs"?(t&&(t.style.display="none"),n&&(n.style.display="block"),s&&(s.style.display="none"),o&&(o.style.display="none")):e==="videos"?(t&&(t.style.display="none"),n&&(n.style.display="none"),s&&(s.style.display="block"),o&&(o.style.display="none")):e==="books"&&(t&&(t.style.display="none"),n&&(n.style.display="none"),s&&(s.style.display="none"),o&&(o.style.display="block"));const i=document.querySelector(`#resourcesSection .resource-tab-btn[onclick="showResourceTab('${e}')"]`);i&&i.classList.add("active"),$&&Ee($,e)}function ut(e){const t=document.getElementById("guestNotesTab"),n=document.getElementById("guestPyqsTab"),s=document.getElementById("guestVideosTab"),o=document.getElementById("guestBooksTab");document.querySelectorAll("#guestResourcesTab .resource-tab-btn").forEach(c=>c.classList.remove("active")),e==="notes"?(t&&(t.style.display="block"),n&&(n.style.display="none"),s&&(s.style.display="none"),o&&(o.style.display="none")):e==="pyqs"?(t&&(t.style.display="none"),n&&(n.style.display="block"),s&&(s.style.display="none"),o&&(o.style.display="none")):e==="videos"?(t&&(t.style.display="none"),n&&(n.style.display="none"),s&&(s.style.display="block"),o&&(o.style.display="none")):e==="books"&&(t&&(t.style.display="none"),n&&(n.style.display="none"),s&&(s.style.display="none"),o&&(o.style.display="block"));const i=document.querySelector(`#guestResourcesTab .resource-tab-btn[onclick="showGuestResourceTab('${e}')"]`);i&&i.classList.add("active");const r=document.getElementById("guestResourceSubjectSelect");r&&r.value&&Se(r.value,e)}async function mt(){const e=document.getElementById("resourceSubjectSelect"),t=document.getElementById("resourcesContent");if(!e.value){t.style.display="none",$=null;return}$=e.value,t.style.display="block",await Ee($,lt)}async function ft(){const e=document.getElementById("guestResourceSubjectSelect"),t=document.getElementById("guestResourcesContent");if(!e.value){t.style.display="none";return}t.style.display="block",await Se(e.value,"notes"),await Se(e.value,"pyqs"),await Se(e.value,"videos")}async function Ee(e,t){try{if(!S||!D){console.log("Database not available");return}const n=await S.collection("subjectResources").doc(e).collection(t).orderBy("createdAt","desc").get(),s=[];n.forEach(o=>{s.push({id:o.id,...o.data()})}),Ve(s,t)}catch(n){console.error("Error loading resources:",n),Ve([],t)}}async function Se(e,t){try{if(!S||!D){console.log("Database not available");return}const n=await S.collection("subjectResources").doc(e).collection(t).orderBy("createdAt","desc").get(),s=[];n.forEach(o=>{s.push({id:o.id,...o.data()})}),qe(s,t)}catch(n){console.error("Error loading guest resources:",n),qe([],t)}}function Ve(e,t){const n=t+"List",s=document.getElementById(n);if(s){if(e.length===0){s.innerHTML=`
      <div class="empty-state">
        <div class="empty-state-icon">${pt(t)}</div>
        <h3>No ${q(t)} Added Yet</h3>
        <p>Add your first ${q(t).toLowerCase()} using the form above.</p>
      </div>
    `;return}t==="books"?s.innerHTML=e.map(o=>`
      <div class="resource-item book-item">
        <div class="resource-header">
          <h4 class="resource-title book-title">${G(o.title)}</h4>
          <div class="book-author">by ${G(o.author)}</div>
        </div>
        
        <div class="resource-actions">
          <a href="${G(o.url)}" target="_blank" class="resource-btn">
            üìñ Open Book
          </a>
          <button onclick="deleteResource('${o.id}', '${$}', '${t}')" class="resource-btn delete">
            üóëÔ∏è Delete
          </button>
        </div>
      </div>
    `).join(""):s.innerHTML=e.map(o=>`
      <div class="resource-item">
        <div class="resource-header">
          <h4 class="resource-title">${G(o.title)}</h4>
        </div>
        ${t==="notes"&&o.author?`<div class="resource-author">by ${G(o.author)}</div>`:""}
        ${t!=="notes"&&o.description?`<div class="resource-description">${G(o.description)}</div>`:""}
        <div class="resource-meta">
          ${o.year?`<span>Year: ${G(o.year)}</span>`:""}
          ${o.type?`<span>Type: ${G(o.type)}</span>`:""}
          <span>Added: ${yt(o.createdAt)}</span>
        </div>
        <div class="resource-actions">
          <a href="${G(o.url)}" target="_blank" class="resource-btn">
            üîó Open ${q(t)}
          </a>
          <button onclick="deleteResource('${o.id}', '${$}', '${t}')" class="resource-btn delete">
            üóëÔ∏è Delete
          </button>
        </div>
      </div>
    `).join("")}}function qe(e,t){const n="guest"+t.charAt(0).toUpperCase()+t.slice(1)+"List",s=document.getElementById(n);if(s){if(e.length===0){s.innerHTML=`
      <div class="empty-state">
        <div class="empty-state-icon">${pt(t)}</div>
        <h3>No ${q(t)} Available</h3>
        <p>Check back later for ${q(t).toLowerCase()}.</p>
      </div>
    `;return}t==="books"?s.innerHTML=e.map(o=>`
      <div class="resource-item book-item">
        <div class="resource-header">
          <h4 class="resource-title book-title">${G(o.title)}</h4>
          <div class="book-author">by ${G(o.author)}</div>
        </div>
        
        <div class="resource-actions">
          <a href="${G(o.url)}" target="_blank" class="resource-btn">
            üìñ Open Book
          </a>
        </div>
      </div>
    `).join(""):s.innerHTML=e.map(o=>`
      <div class="resource-item">
        <div class="resource-header">
          <h4 class="resource-title">${G(o.title)}</h4>
        </div>
        ${t==="notes"&&o.author?`<div class="resource-author">by ${G(o.author)}</div>`:""}
        ${t!=="notes"&&o.description?`<div class="resource-description">${G(o.description)}</div>`:""}
        <div class="resource-meta">
          ${o.year?`<span>Year: ${G(o.year)}</span>`:""}
          ${o.type?`<span>Type: ${G(o.type)}</span>`:""}
          <span>Added: ${yt(o.createdAt)}</span>
        </div>
        <div class="resource-actions">
          <a href="${G(o.url)}" target="_blank" class="resource-btn">
            üîó Open ${q(t)}
          </a>
        </div>
      </div>
    `).join("")}}async function gt(e){try{if(!$){alert("Please select a subject first");return}let t,n,s,o,a,i;if(e==="notes"?(t=document.getElementById("noteTitle").value.trim(),i=document.getElementById("noteAuthor").value.trim(),n=document.getElementById("noteUrl").value.trim()):e==="pyqs"?(t=document.getElementById("pyqTitle").value.trim(),o=document.getElementById("pyqYear").value.trim(),a=document.getElementById("pyqType").value,n=document.getElementById("pyqUrl").value.trim()):e==="videos"?(t=document.getElementById("videoTitle").value.trim(),s=document.getElementById("videoDescription").value.trim(),n=document.getElementById("videoUrl").value.trim()):e==="books"&&(t=document.getElementById("bookTitle").value.trim(),i=document.getElementById("bookAuthor").value.trim(),n=document.getElementById("bookUrl").value.trim()),e==="books"){if(!t||!i||!n){alert("Please fill in all required fields (Title, Author, and URL)");return}if(!ze(n)){alert("Please enter a valid URL");return}}else{if(!t||!n){alert("Please fill in the title and URL fields");return}if(!ze(n)){alert("Please enter a valid URL");return}}const r={title:t,subjectCode:$,createdAt:new Date,updatedAt:new Date};e==="books"?(r.author=i,r.url=n):e==="notes"?(r.url=n,i&&(r.author=i)):(r.url=n,s&&(r.description=s),o&&(r.year=o),a&&(r.type=a)),await S.collection("subjectResources").doc($).collection(e).add(r),e==="notes"?(document.getElementById("noteTitle").value="",document.getElementById("noteAuthor").value="",document.getElementById("noteUrl").value=""):e==="pyqs"?(document.getElementById("pyqTitle").value="",document.getElementById("pyqYear").value="",document.getElementById("pyqType").value="",document.getElementById("pyqUrl").value=""):e==="videos"?(document.getElementById("videoTitle").value="",document.getElementById("videoDescription").value="",document.getElementById("videoUrl").value=""):e==="books"&&(document.getElementById("bookTitle").value="",document.getElementById("bookAuthor").value="",document.getElementById("bookUrl").value=""),await Ee($,e),T(`${q(e)} added successfully!`,"success")}catch(t){console.error("Error adding resource:",t),alert("Failed to add resource. Please try again.")}}async function qt(e,t,n){if(confirm(`Are you sure you want to delete this ${q(n).toLowerCase()}?`))try{await S.collection("subjectResources").doc(t).collection(n).doc(e).delete(),await Ee(t,n),T(`${q(n)} deleted successfully!`,"success")}catch(s){console.error("Error deleting resource:",s),alert("Failed to delete resource. Please try again.")}}function pt(e){switch(e){case"notes":return"üìù";case"pyqs":return"üìã";case"videos":return"üé•";case"books":return"üìñ";default:return"üìÑ"}}function q(e){switch(e){case"notes":return"Notes";case"pyqs":return"Previous Year Questions";case"videos":return"Videos";case"books":return"Books";default:return"Resource"}}function G(e){if(!e)return"";const t=document.createElement("div");return t.textContent=e,t.innerHTML}function yt(e){if(!e)return"Unknown";let t;return e.toDate?t=e.toDate():e instanceof Date?t=e:t=new Date(e),t.toLocaleDateString("en-US",{year:"numeric",month:"short",day:"numeric"})}function ze(e){try{return new URL(e),!0}catch{return!1}}function zt(e){window.open(e,"_blank")}function Yt(e){try{const t=document.createElement("a");t.href=e,t.target="_blank",t.rel="noopener noreferrer",document.body.appendChild(t),t.click(),document.body.removeChild(t)}catch{window.open(e,"_blank")}}function Wt(e){const n={timetable:"Time Table",syllabus:"Syllabus",calendar:"Academic Calendar"}[e]||"Document";if(confirm(`Do you want to edit the ${n}?

This will allow you to upload a new ${n.toLowerCase()} file.`)){const o=document.createElement("input");o.type="file",o.style.display="none",e==="timetable"?o.accept=".png,.jpg,.jpeg,.gif,.bmp,.svg":o.accept=".pdf",o.onchange=function(a){const i=a.target.files[0];i&&Qt(i,e)},document.body.appendChild(o),o.click(),document.body.removeChild(o)}}function Qt(e,t){T(`${e.name} selected for ${t}. Upload functionality would be implemented here.`,"info"),console.log(`File selected: ${e.name} for ${t}`)}function Zt(e){return new URL(window.location.href).searchParams.get(e)}function ie(e,t){const n=document.getElementById(e);n&&(n.textContent=t)}function Ce(e){const t=document.getElementById("errorBox");t&&(t.style.display="block",t.textContent=e)}function Ye(e,t){return t?Math.round(e/t*100)+"%":"0%"}function Xt(e,t){const n=t?e/t:0;return n>=.75?"pill green":n>=.5?"pill orange":"pill red"}async function en(){if(!S)throw new Error("Firestore not initialized");return(await S.collection("attendanceSessions").orderBy("date","asc").get()).docs.map(t=>({id:t.id,...t.data()}))}async function tn(e){return(await S.collectionGroup("attendance").where("studentId","==",String(e)).get()).docs.map(n=>({id:n.id,...n.data(),_path:n.ref.path}))}async function ht(e,t){try{return await tn(e)}catch(n){if(n&&(n.code==="failed-precondition"||String(n.message||"").includes("COLLECTION_GROUP"))){const s=[];for(let a=0;a<t.length;a+=10){const r=t.slice(a,a+10).map(async d=>{try{const m=await S.collection("attendanceSessions").doc(d.id).collection("attendance").where("studentId","==",String(e)).limit(1).get();if(!m.empty){const b=m.docs[0];return{id:b.id,...b.data(),_path:b.ref.path}}}catch{}return null});(await Promise.all(r)).forEach(d=>{d&&s.push(d)})}return s}throw n}}async function Ie(){try{let e=function(l){return l?l.replace(/^[A-Z]{2,4}\d{4}\s*-\s*/i,"").trim()||l:"General"};const t=Zt("id");if(!t){Ce("Missing student id in URL.");return}ie("metaId",t),ie("studentDetailsName","Loading...");try{await new Promise(l=>{let u=!1;K?(K.onAuthStateChanged(async()=>{u||(u=!0,A.length===0&&await et(),l())}),setTimeout(()=>{u||(u=!0,l())},1500)):l()})}catch{}const n=await en();if(!n.length){Ce("No attendance sessions found.");return}const s=await ht(t,n),o=new Map(n.map(l=>[l.sessionId||l.id,l])),a=new Map,i=n.length;let r=0,c=null,d=null;for(const l of s){const u=l.sessionId||l.session||l._sessionId,g=o.get(u),h=l.subjectName||g&&(g.subjectName||g.subject)||l.subjectCode||"General",E=e(h),_=a.get(E)||{total:0,present:0};_.present+=1,a.set(E,_),r+=1,!c&&(l.name||l.studentName)&&(c=l.name||l.studentName),!d&&(l.father||l.fatherName)&&(d=l.father||l.fatherName)}const m=new Map;for(const l of n){const u=l.subjectName||l.subject||l.subjectCode||"General",g=e(u);m.set(g,(m.get(g)||0)+1)}for(const[l,u]of m.entries()){const g=a.get(l)||{total:0,present:0};g.total=u,a.set(l,g)}if(!c||!d){const l=[t,String(t),Number(t),t.trim(),t.padStart(2,"0")];let u=null;if(Array.isArray(A)){for(const g of l)if(u=A.find(h=>h&&(h.id===g||String(h.id)===String(g)||Number(h.id)===Number(g))),u)break}u&&(!c&&u.name&&(c=u.name),!d&&u.father&&(d=u.father))}const b=c||`Student ${t}`;ie("studentDetailsName",b),ie("metaFather",d||"-"),ie("overall",Ye(r,i)),ie("totalSessions",String(i));const f=document.getElementById("subjectList");if(f){f.innerHTML="";const l=Array.from(a.entries()).sort((u,g)=>String(u[0]).localeCompare(String(g[0])));for(const[u,g]of l){const h=document.createElement("div");h.className="subject-item";const E=document.createElement("div");E.innerHTML=`<span class="subject-name">${u}</span><br/><small>${g.present}/${g.total} present</small>`;const _=document.createElement("div"),L=document.createElement("span");L.className=Xt(g.present,g.total),L.textContent=Ye(g.present,g.total),_.appendChild(L),h.appendChild(E),h.appendChild(_),f.appendChild(h)}}}catch{Ce("Failed to load student attendance. See console for details.")}}function ye(e){return e*(Math.PI/180)}function bt(e,t,n,s){const a=ye(n-e),i=ye(s-t),r=Math.sin(a/2)*Math.sin(a/2)+Math.cos(ye(e))*Math.cos(ye(n))*Math.sin(i/2)*Math.sin(i/2);return 6371e3*(2*Math.atan2(Math.sqrt(r),Math.sqrt(1-r)))}function H(e,t,n=!1){const s=document.getElementById("locationStatus");if(!s)return;s.className=`location-status ${t} show`,s.innerHTML="";let o="";n?o='<div class="loading-spinner"></div>':t==="allowed"?o='<i class="fas fa-check-circle"></i>':t==="denied"&&(o='<i class="fas fa-exclamation-circle"></i>');const a=document.createElement("span");if(a.textContent=e,s.innerHTML=o,s.appendChild(a),typeof locationManager<"u"&&(t==="checking"||n)){const i=locationManager.queue.getQueueStatus(),r=locationManager.getPerformanceMetrics();if(i.total>0){const c=document.createElement("div");c.className="queue-info",c.style.cssText="font-size: 0.85em; color: #666; margin-top: 5px;",c.innerHTML=`üìä Queue: ${i.total} waiting, ${i.active} processing`,s.appendChild(c)}if(r.totalRequests>0){const c=document.createElement("div");c.className="performance-info",c.style.cssText="font-size: 0.85em; color: #666; margin-top: 3px;";let d=`‚ö° ${r.successRate}% success rate`;r.averageResponseTime>0&&(d+=`, ${r.averageResponseTime}ms avg`),parseFloat(r.cacheHitRate)>0&&(d+=`, ${r.cacheHitRate}% cached`),c.textContent=d,s.appendChild(c)}if(i.total>5){const c=Math.ceil(i.total*(r.averageResponseTime||2e3)/1e3),d=document.createElement("div");d.className="wait-info",d.style.cssText="font-size: 0.85em; color: #ff9800; margin-top: 3px; font-weight: 500;",d.innerHTML=`‚è±Ô∏è Estimated wait: ~${c}s (high traffic)`,s.appendChild(d)}}n?s.classList.add("pulse"):s.classList.remove("pulse"),t==="allowed"&&setTimeout(()=>{s.className.includes("allowed")&&(s.style.display="none")},8e3),t==="denied"&&setTimeout(()=>{s.className.includes("denied")&&(s.style.display="none")},15e3)}async function St(e=0){Ke++;try{if(console.log(`Starting location verification (request #${Ke})...`),H("üìç Initializing location services...","checking",10),!navigator.geolocation)throw new Error("Geolocation is not supported by this browser");H("üì° Requesting GPS access...","checking",30);const t=await Nt();return H("üîç Validating location data...","checking",70),Tt(t.userLat,t.userLng,t.accuracy),H("üìè Calculating distance to campus...","checking",90),t.success?(H(`‚úÖ Location verified! Distance: ${t.distance}m (Accuracy: ¬±${t.accuracy}m)`,"allowed",100),localStorage.setItem("lastValidLocation",JSON.stringify({timestamp:Date.now(),distance:t.distance,accuracy:t.accuracy})),Rt++,{success:!0,distance:t.distance,accuracy:t.accuracy,coordinates:{lat:t.userLat,lng:t.userLng}}):(H(`‚ùå Location verification failed! Distance: ${t.distance}m (Max allowed: ${Ze}m)`,"denied"),{success:!1,distance:t.distance,accuracy:t.accuracy,reason:"Outside allowed radius"})}catch(t){return console.error("Location verification failed:",t.message),H(`‚ùå Location Error: ${t.message}`,"error"),tt({success:!1,error:t.message,timestamp:Date.now()}),{success:!1,error:t.message}}}function nn(){if(window.matchMedia){const e=window.matchMedia("(prefers-color-scheme: dark)");e.matches?document.documentElement.setAttribute("data-theme","dark"):document.documentElement.setAttribute("data-theme","light"),e.addEventListener("change",t=>{t.matches?document.documentElement.setAttribute("data-theme","dark"):document.documentElement.setAttribute("data-theme","light")})}}nn();function T(e,t="success"){const n=document.getElementById("notification");n.textContent=e,n.className=`notification ${t}`,n.classList.add("show"),setTimeout(()=>{n.classList.remove("show")},3e3)}function V(e,t){const n=document.getElementById("firebaseStatus");n&&(n.textContent=e,n.className=`firebase-status ${t}`)}function fe(e){if(e)for(;e.firstChild;)e.removeChild(e.firstChild)}function j(e,t,n){if(!e)return;fe(e);const s=document.createElement("div");s.className=`${t}-message`,s.textContent=n,e.appendChild(s)}function on(){const e=document.getElementById("loadingMessage");return Array.isArray(A)&&A.length>0?(e&&(e.style.display="none"),!0):(e&&(e.innerHTML="‚è≥ Loading students from Firestore...",e.style.background="#fff3cd",e.style.color="#856404"),!1)}function te(){const e=document.getElementById("attendanceDate").value,t=document.getElementById("subjectCode").value,n=document.getElementById("secretCode").value.trim(),s=on(),o=document.getElementById("startBtn"),a=e&&t&&n&&s;return o.disabled=!a,a}async function Te(){var e,t;try{const n=(e=document.getElementById("attendanceDate"))==null?void 0:e.value,s=(t=document.getElementById("subjectCode"))==null?void 0:t.value,o=document.getElementById("secretCode"),a=document.getElementById("startBtn");if(!n||!s){a&&(a.textContent="Start Attendance Session"),o&&(o.readOnly=!1);return}const r=new Date(n).toLocaleDateString("en-GB"),c=await At(r,s);c&&c.id?(C=c.id,p=c,Z=c.secretCode||"",o&&(o.value=Z,o.readOnly=!0),a&&(a.textContent="View Attendance Session"),te()):(o&&(o.readOnly=!1,o.value=""),a&&(a.textContent="Start Attendance Session"),te())}catch{}}function sn(){const e=new Uint8Array(16);(window.crypto||window.msCrypto).getRandomValues(e);let t="";for(let n=0;n<e.length;n++)t+=e[n].toString(16).padStart(2,"0");return"ATT_"+t}function an(e,t){const s=new Date(e).toLocaleDateString("en-US",{weekday:"long"}),o=xt[s];if(o){for(const a in o)if(o[a][t])return{timeSlot:a,teacher:o[a][t]}}return{timeSlot:"Not Scheduled",teacher:"To Be Assigned"}}function rn(e){if(!e)return"N/A";try{let t;return e&&typeof e.toDate=="function"?t=e.toDate():typeof e=="string"?t=new Date(e):e&&typeof e.seconds=="number"?t=new Date(e.seconds*1e3):t=new Date(e),isNaN(t.getTime())?"Invalid Date":t.toLocaleString()}catch{return"Invalid Date"}}window.testExpiry=function(){const e={sessionId:"TEST_123",date:new Date().toLocaleDateString("en-GB"),expiryTime:new Date(Date.now()-1e3).toISOString()};z(e);const t={sessionId:"TEST_456",date:new Date().toLocaleDateString("en-GB"),expiryTime:new Date(Date.now()+36e5).toISOString()};z(t)};function z(e){if(!e||e.isExpired===!0)return!0;if(!e.expiryTime){let n;if(e.date)try{const i=e.date.split("/");if(i.length===3){const[r,c,d]=i,m=new Date(parseInt(d),parseInt(c)-1,parseInt(r));!isNaN(m.getTime())&&m.getFullYear()>=2020?n=m:n=new Date}else n=new Date}catch{n=new Date}else n=new Date;const s=2*60*60*1e3,a=Date.now()-n.getTime()>s;return n.toISOString(),a}const t=new Date;if(!e.expiryTime||e.expiryTime==="Invalid Date")return!0;try{let n;if(e.expiryTime&&typeof e.expiryTime.toDate=="function"?n=e.expiryTime.toDate():typeof e.expiryTime=="string"?n=new Date(e.expiryTime):e.expiryTime&&typeof e.expiryTime.seconds=="number"?n=new Date(e.expiryTime.seconds*1e3):n=new Date(e.expiryTime),isNaN(n.getTime()))return!0;const s=5*60*1e3,o=t.getTime()>n.getTime()+s;return t.toISOString(),n.toISOString(),o}catch{return!0}}async function cn(){var e,t;if(!C){alert("No active session to expire");return}if(confirm("Are you sure you want to expire this attendance session? Students will no longer be able to mark attendance."))try{D&&await S.collection("attendanceSessions").doc(C).update({isExpired:!0,expiredAt:firebase.firestore.FieldValue.serverTimestamp(),status:"expired"});const n=`session_${p.date}_${p.subjectCode}`,s=JSON.parse(localStorage.getItem(n)||"{}");s.isExpired=!0,s.expiredAt=new Date().toISOString(),localStorage.setItem(n,JSON.stringify(s)),localStorage.setItem("attendanceSession_"+C,JSON.stringify(s)),document.getElementById("sessionExpired").style.display="block",document.getElementById("expiryInfo").textContent="Session expired manually",document.getElementById("expiryInfo").style.color="#e74c3c",(e=document.getElementById("studentCheckinForm"))==null||e.style.setProperty("opacity","0.5"),(t=document.getElementById("studentCheckinForm"))==null||t.style.setProperty("pointer-events","none");const o=document.querySelector('.share-btn[onclick="expireSessionManually()"]');o&&(o.textContent="üîÑ Restart Session",o.style.backgroundColor="#27ae60",o.setAttribute("onclick","restartSession()")),T("Session expired successfully","success")}catch{alert("Error expiring session. Please try again.")}}async function ln(){if(!te()){alert("Please ensure all fields are filled including the secret code");return}const e=document.getElementById("attendanceDate").value,t=document.getElementById("subjectCode").value,n=document.getElementById("secretCode").value.trim().toUpperCase(),s=new Date(e),o=s.toLocaleDateString("en-US",{weekday:"long"}),a=s.toLocaleDateString("en-GB"),i=await At(a,t);let r=!1;if(i&&i.id?z(i)?(C=i.id,p=i,Z=i.secretCode||n,T("üìñ Viewing expired attendance session","info"),await We(C)):(C=i.id,p=i,Z=i.secretCode||n,T("üìö Continuing existing attendance session","success"),await We(C)):r=!0,r){const m=an(e,t);C=sn(),Z=n;const b=new Date;b.setHours(b.getHours()+1),p={sessionId:C,date:a,day:o,timeSlot:m.timeSlot,subjectCode:t,subjectName:Be[t],teacherName:m.teacher,secretCode:Z,expiryTime:b.toISOString(),isExpired:!1,createdAt:new Date().toISOString()},await pn(p),T("‚úÖ New attendance session started (expires in 1 hour)","success"),N={},v={}}le=Gt(C);const c=z(p),d=r?"New":c?"Viewing Expired":"Continuing";if(document.getElementById("classInfo").innerHTML=`
    <h3>${d} Attendance Session</h3>
    <div class="class-details">
      <div><strong>Date:</strong> ${p.date} (${p.day})</div>
      <div><strong>Time:</strong> ${p.timeSlot}</div>
      <div><strong>Subject:</strong> ${p.subjectName}</div>
      <div><strong>Teacher:</strong> ${p.teacherName}</div>
      ${!r&&!c?"<div><strong>Status:</strong> Existing session resumed</div>":""}
    </div>
    <div class="secret-code-info">
      <strong>üîë Secret Code:</strong>
      <div class="secret-code-display">${Z}</div>
    </div>
    <div class="expiry-info" id="expiryInfo">
      ${c?"<strong>‚è∞ Expired:</strong> This session has expired":`<strong>‚è∞ Expires:</strong> ${rn(p.expiryTime)}`}
    </div>
    ${c?'<div class="session-expired" id="sessionExpired">‚ùå Session Expired - Students can no longer mark attendance</div>':""}
  `,document.getElementById("sessionUrl").textContent=le,c){const m=document.querySelector('.share-btn[onclick="expireSessionManually()"]');m&&(m.textContent="üîÑ Restart Session",m.style.backgroundColor="#27ae60",m.setAttribute("onclick","restartSession()"))}document.getElementById("setupSection").style.display="none",document.getElementById("attendanceSection").style.display="block",Y(),yn()}function dn(){navigator.clipboard.writeText(le).then(()=>{T("‚úÖ Link copied to clipboard!")}).catch(()=>{const e=document.createElement("textarea");e.value=le,document.body.appendChild(e),e.select(),document.execCommand("copy"),document.body.removeChild(e),T("‚úÖ Link copied to clipboard!")})}function un(){const e=`*"GNDU Attendance System"*

${p.subjectName}
Date: ${p.date}
Time: ${p.timeSlot}
Teacher: ${p.teacherName}

*"Important Requirements:"*
1. You must be inside the university campus
2. You must enter the secret code correctly told in classroom

Click this link to mark your attendance:
${le}`,t=`https://wa.me/?text=${encodeURIComponent(e)}`;window.open(t,"_blank")}function Le(){const e=document.getElementById("studentDetailsModal");if(e&&(e.style.display="none",document.body.classList.remove("modal-open"),window.history.replaceState)){const t=window.location.pathname;window.history.replaceState({},document.title,t)}}document.addEventListener("DOMContentLoaded",function(){const e=document.getElementById("closeStudentDetails");e&&e.addEventListener("click",Le);const t=document.getElementById("studentDetailsModal");if(t&&t.addEventListener("click",function(o){o.target===t&&Le()}),window.addEventListener("popstate",function(){const o=new URLSearchParams(window.location.search),a=o.get("view")==="student",i=o.get("id"),r=document.getElementById("studentDetailsModal");r&&(a&&i?(r.style.display="flex",document.body.classList.add("modal-open"),Ie().catch(console.error)):Le())}),new URLSearchParams(window.location.search).get("session"))(function(){const a=typeof A<"u"&&Array.isArray(A)?A:Array.isArray(window.students)?window.students:[];!Array.isArray(a)||a.length===0||(window.rollNumbers=window.rollNumbers||{},window.idByRoll=window.idByRoll||{},Object.keys(window.rollNumbers).length===0&&a.forEach((i,r)=>{const c=r+1,d=String(i.id);window.rollNumbers[d]=c,window.idByRoll[c]=d}),xe())})(),Me();else{const o=new Date().toISOString().split("T")[0];document.getElementById("attendanceDate").value=o,document.getElementById("attendanceDate").addEventListener("change",()=>{te(),Te()}),document.getElementById("subjectCode").addEventListener("change",()=>{te(),Te()}),document.getElementById("secretCode").addEventListener("input",te),document.getElementById("startBtn").addEventListener("click",ln),document.getElementById("loginPassword").addEventListener("keypress",function(c){c.key==="Enter"&&handleLogin()}),document.getElementById("search")&&document.getElementById("search").addEventListener("keyup",Y);const a=document.getElementById("printBtn");a&&a.addEventListener("click",c=>{c.preventDefault(),Sn()?An():Ae()});const i=document.getElementById("printAsIsBtn");i&&i.addEventListener("click",c=>{c.preventDefault(),Et()});const r=document.getElementById("exportBtn");r&&r.addEventListener("click",c=>{c.preventDefault(),wt()}),Array.isArray(window.students)&&(window.rollNumbers={},window.idByRoll={},window.students.forEach((c,d)=>{const m=d+1,b=String(c.id);window.rollNumbers[b]=m,window.idByRoll[m]=b})),xe(),gn(),Te(),Me(),xe(),Y()}});window.addEventListener("beforeunload",function(){hn()});function Me(){const e=typeof A<"u"&&Array.isArray(A)?A:Array.isArray(window.students)?window.students:[];!Array.isArray(e)||e.length===0||(window.rollNumbers||(window.rollNumbers={}),window.idByRoll||(window.idByRoll={}),Object.keys(window.rollNumbers).length===0&&e.forEach((t,n)=>{const s=n+1,o=String(t.id);window.rollNumbers[o]=s,window.idByRoll[s]=o}))}function J(e){var s;Me();const t=String(e);let n=(s=window.rollNumbers)==null?void 0:s[t];if(!n){const a=(typeof A<"u"&&Array.isArray(A)?A:Array.isArray(window.students)?window.students:[]).findIndex(i=>String(i.id)===t);a>=0&&(n=a+1,window.rollNumbers[t]=n,window.idByRoll[n]=t)}return n||""}function xe(){try{const e=document.getElementById("studentId");if(!e)return;const n=(typeof A<"u"&&Array.isArray(A)?A:Array.isArray(window.students)?window.students:[]).length;n>0&&(e.placeholder=`Enter your Roll Number (1-${n})`)}catch{}}function $e(e,t=!0){return function(n,s){let o=(n[e]||"").toString().toUpperCase(),a=(s[e]||"").toString().toUpperCase();return o<a?t?-1:1:o>a?t?1:-1:0}}function mn(e,t){const n=!!N[e.id],s=!!N[t.id];if(X==="presentFirst"){if(n&&!s)return-1;if(!n&&s)return 1}else if(X==="absentFirst"){if(!n&&s)return-1;if(n&&!s)return 1}return $e("name",!0)(e,t)}function fn(e){return P?P==="status"?e.sort(mn):P==="time"?e.sort((t,n)=>{const s=v[t.id]||"",o=v[n.id]||"";return s===""&&o!==""?O?1:-1:o===""&&s!==""?O?-1:1:s===""&&o===""?0:O?s.localeCompare(o):o.localeCompare(s)}):P==="roll"?e.sort((t,n)=>{const s=J(t.id)||0,o=J(n.id)||0;return O?s-o:o-s}):e.sort($e(P,O)):e}function gn(){const e={rollHeader:"roll",studentIdHeader:"id",nameHeader:"name",fatherHeader:"father",statusHeader:"status",timeHeader:"time"};Object.keys(e).forEach(t=>{const n=document.getElementById(t),s=e[t];n&&(n.dataset.originalText=n.textContent,n.addEventListener("click",function(){if(Object.keys(e).forEach(o=>{const a=document.getElementById(o);a&&(a.classList.remove("sorted"),a.textContent=a.dataset.originalText)}),s==="status")P!=="status"?(P="status",X="presentFirst",n.textContent="Status (Present First)"):X==="presentFirst"?(X="absentFirst",n.textContent="Status (Absent First)"):(P=null,X=null,n.textContent=n.dataset.originalText);else{P===s?O=!O:(P=s,O=!1,s!=="name"&&(O=!0)),X=null;const o=O?" ‚ñ≤":" ‚ñº";n.textContent=n.dataset.originalText+o}P&&n.classList.add("sorted"),Y()}))})}function _e(){var n;if(typeof A>"u"||!Array.isArray(A))return[];let e=A.slice();const t=((n=document.getElementById("search"))==null?void 0:n.value.toLowerCase())||"";return t!==""?(e=e.filter(s=>{const o=String(J(s.id)||"").toLowerCase();return s.name.toLowerCase().includes(t)||s.father.toLowerCase().includes(t)||s.id.toLowerCase().includes(t)||o.includes(t)}),e):fn(e)}async function At(e,t){if(!D){const n=`session_${e}_${t}`,s=localStorage.getItem(n);return s?JSON.parse(s):null}try{const s=await S.collection("attendanceSessions").where("date","==",e).where("subjectCode","==",t).limit(1).get();if(!s.empty){const o=s.docs[0];return{id:o.id,...o.data()}}return null}catch{return null}}async function We(e){const t={...N},n={...v};if(N={},v={},D)try{(await S.collection("attendanceSessions").doc(e).collection("attendance").get()).forEach(r=>{const c=r.data(),d=r.id;N[d]=!0,c.markedAt&&c.markedAt.seconds?v[d]=new Date(c.markedAt.seconds*1e3).toLocaleTimeString():v[d]=c.time||"-"}),`${Object.keys(N).length}`}catch{}const s="attendance_"+e,o=JSON.parse(localStorage.getItem(s)||"{}");Object.keys(o).forEach(a=>{N[a]||(N[a]=!0,v[a]=o[a].time||"-")}),Object.keys(t).forEach(a=>{N[a]||(N[a]=t[a],v[a]=n[a]||"-")}),`${Object.keys(N).length}`}async function pn(e){const t=new Date;t.setHours(t.getHours()+1);const n={...e,secretCode:e.secretCode||"",expiryTime:t.toISOString(),isExpired:!1,createdAt:e.createdAt||new Date().toISOString()},s=`session_${e.date}_${e.subjectCode}`,o=JSON.stringify(n);if(localStorage.setItem(s,o),localStorage.setItem("attendanceSession_"+e.sessionId,o),!!D)try{await S.collection("attendanceSessions").doc(e.sessionId).set({...n,createdAt:firebase.firestore.FieldValue.serverTimestamp(),status:"active",totalStudents:A.length,presentCount:0,expiryTime:firebase.firestore.Timestamp.fromDate(t),isExpired:!1})}catch{}}function yn(){if(C){re&&re();try{re=S.collection("attendanceSessions").doc(C).collection("attendance").onSnapshot(t=>{t.docChanges().length,t.docChanges().forEach(n=>{var a,i,r,c;const s=n.doc.data(),o=s.studentId;if(o)switch(n.type){case"added":case"modified":N[o]=!0,v[o]=((i=(a=s.timestamp)==null?void 0:a.toDate)==null?void 0:i.call(a))||((c=(r=s.markedAt)==null?void 0:r.toDate)==null?void 0:c.call(r))||new Date,A.find(m=>m.id.toString()===o)&&Qe(o,"present",v[o]);break;case"removed":delete N[o],delete v[o],Qe(o,"absent",null);break}}),ue(),V("üü¢ Connected to Firebase","connected"),Y()},t=>{loadOfflineAttendance(),V("‚ö†Ô∏è Working in offline mode","warning"),T("Connection issues. Working in offline mode.","error")})}catch{loadOfflineAttendance(),V("‚ö†Ô∏è Working in offline mode","warning"),T("Working in offline mode. Data will sync when back online.","warning")}}}function Qe(e,t,n){if(e){if(N[e]=t==="present",n){const s=n instanceof Date?n:n.toDate();v[e]=s.toLocaleTimeString()}else v[e]=new Date().toLocaleTimeString();ue(),Y()}}function hn(){re&&(re(),re=null)}async function bn(e,t){try{const n=`Are you sure you want to manually mark "${t}" as present?`;if(!confirm(n))return;if(!C&&!p){T("Please start an attendance session first.","error");return}const s=C||p&&p.sessionId;if(!s){T("No active session found. Please start an attendance session.","error");return}if(N[e]=!0,v[e]=new Date().toLocaleTimeString(),ue(),Y(),T("Marking student as present...","info"),S&&D)try{const o=new Date,a={studentId:e.toString(),studentName:t,time:o.toLocaleTimeString(),timestamp:firebase.firestore.FieldValue.serverTimestamp(),localTimestamp:o.toISOString(),status:"present",manuallyMarked:!0,markedBy:"teacher",sessionId:s},i=S.collection("attendanceSessions").doc(s),r=i.collection("attendance").doc(e);await i.update({[`attendance.${e}`]:!0}),await r.set(a);const c=`attendance_${s}_${e}`;localStorage.setItem(c,"true"),T(`‚úÖ ${t} has been marked as present`,"success")}catch(o){console.error("Error saving manual attendance to Firebase:",o),T("Attendance marked locally. Will sync when connection is restored.","warning");const a=`attendance_${s}_${e}`;localStorage.setItem(a,"true")}else{const o=`attendance_${s}_${e}`;localStorage.setItem(o,"true"),T("Attendance marked locally. Will sync when connection is restored.","warning")}}catch(n){console.error("Error in manual attendance marking:",n),T("Failed to mark attendance. Please try again.","error"),N[e]=!1,delete v[e],ue(),Y()}}function ue(){var i;if((((i=document.getElementById("search"))==null?void 0:i.value.toLowerCase())||"")!=="")return;const t=A||[],n=t.filter(r=>N[r.id]).length,s=t.length,o=s-n,a=s>0?Math.round(n/s*100):0;document.getElementById("totalStudents").textContent=s,document.getElementById("presentCount").textContent=n,document.getElementById("absentCount").textContent=o,document.getElementById("attendancePercent").textContent=a+"%"}function Y(){const e=document.getElementById("studentTable"),t=_e();fe(e),t.forEach((n,s)=>{const o=document.createElement("tr");N[n.id]&&o.classList.add("present");const a=document.createElement("td");a.textContent=String(J(n.id));const i=document.createElement("td");i.textContent=String(n.id);const r=document.createElement("td"),c=document.createElement("a");c.href=`${window.location.pathname}?view=student&id=${encodeURIComponent(String(n.id))}`,c.textContent=String(n.name||""),c.className="student-link",c.title="View attendance details",c.addEventListener("click",function(f){f.preventDefault();const l=c.href;window.history.pushState({path:l},"",l);const u=document.getElementById("studentDetailsModal");u&&(u.style.display="flex",document.body.classList.add("modal-open"),Ie().catch(console.error))}),r.appendChild(c),r.style.cursor="pointer",r.addEventListener("click",f=>{f.target&&f.target.tagName==="A"||c.click()});const d=document.createElement("td");d.textContent=String(n.father||"");const m=document.createElement("td");if(N[n.id]){const f=document.createElement("span");f.className="status-present",f.textContent="Present",m.appendChild(f)}else{const f=document.createElement("div");f.style.display="flex",f.style.alignItems="center",f.style.gap="8px";const l=document.createElement("span");if(l.className="status-absent",l.textContent="Absent",f.appendChild(l),!(localStorage.getItem("guestMode")==="true")){const g=document.createElement("button");g.textContent="Mark Present",g.className="manual-present-btn",g.title="Manually mark this student as present",g.addEventListener("click",function(h){h.stopPropagation(),bn(n.id,n.name)}),f.appendChild(g)}m.appendChild(f)}const b=document.createElement("td");b.textContent=v[n.id]?String(v[n.id]):"-",o.appendChild(a),o.appendChild(i),o.appendChild(r),o.appendChild(d),o.appendChild(m),o.appendChild(b),e.appendChild(o)}),ue()}async function wt(){try{if(!window.ExcelJS){alert("ExcelJS library not loaded. Please check your internet connection and try again.");return}const e=_e(),t=new ExcelJS.Workbook,n=t.addWorksheet("Attendance"),s="GNDU Attendance";n.mergeCells("A1:F1"),n.getCell("A1").value=s,n.getCell("A1").font={size:16,bold:!0},n.getCell("A1").alignment={vertical:"middle",horizontal:"center"};const o=[];p!=null&&p.date&&o.push(`Date: ${p.date}`),p!=null&&p.timeSlot&&o.push(`Time: ${p.timeSlot}`),p!=null&&p.subjectName&&o.push(`Subject: ${p.subjectName}`),p!=null&&p.teacherName&&o.push(`Teacher: ${p.teacherName}`);const a=o.join("  ‚Ä¢  ");a&&(n.mergeCells("A2:F2"),n.getCell("A2").value=a,n.getCell("A2").font={size:11,color:{argb:"FF555555"}},n.getCell("A2").alignment={vertical:"middle",horizontal:"center"});const i=4,r=["Roll Number","Student ID","Name","Father's Name","Status","Check-in Time"];n.getRow(i).values=r,n.columns=[{key:"roll",width:12},{key:"id",width:14},{key:"name",width:28},{key:"father",width:28},{key:"status",width:12},{key:"time",width:16}];const c=n.getRow(i);c.font={bold:!0,color:{argb:"FFFFFFFF"}},c.alignment={vertical:"middle",horizontal:"center"},c.fill={type:"pattern",pattern:"solid",fgColor:{argb:"FF4A5568"}},c.height=20;const d=i+1;e.forEach((h,E)=>{const _=d+E,L=!!N[h.id],W=v[h.id]||"-",x=n.getRow(_);x.values=[J(h.id),String(h.id),String(h.name||""),String(h.father||""),L?"Present":"Absent",String(W)],x.alignment={vertical:"middle"},L&&x.eachCell((R,I)=>{R.fill={type:"pattern",pattern:"solid",fgColor:{argb:"FFEFFAF0"}}});const y=n.getCell(_,5);y.font={bold:!0,color:{argb:L?"FF1F7A1F":"FFB00020"}},y.alignment={horizontal:"center"}});const m=d+e.length-1;for(let h=i;h<=m;h++)for(let E=1;E<=6;E++){const _=n.getCell(h,E);_.border={top:{style:"thin",color:{argb:"FFAAAAAA"}},left:{style:"thin",color:{argb:"FFAAAAAA"}},bottom:{style:"thin",color:{argb:"FFAAAAAA"}},right:{style:"thin",color:{argb:"FFAAAAAA"}}}}n.views=[{state:"frozen",ySplit:i}],["A","B","E","F"].forEach(h=>{n.getColumn(h).alignment={horizontal:"center"}});const b=new Date().toISOString().slice(0,10),f=await t.xlsx.writeBuffer(),l=new Blob([f],{type:"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"}),u=URL.createObjectURL(l),g=document.createElement("a");g.href=u,g.download=`attendance_${b}.xlsx`,document.body.appendChild(g),g.click(),document.body.removeChild(g),URL.revokeObjectURL(u)}catch{alert("Failed to export Excel file. Please try again.")}}function Sn(){return/Android/i.test(navigator.userAgent||"")}async function An(){try{if(typeof html2pdf>"u"){Ae();return}const e=_e(),t=new Date().toISOString().slice(0,10),n="GNDU Attendance",s=document.createElement("div");s.style.padding="16px",s.style.fontFamily="Arial, Helvetica, sans-serif",s.style.color="#000";const o=document.createElement("h1");o.textContent=n,o.style.fontSize="18px",o.style.margin="0 0 8px",s.appendChild(o);const a=document.createElement("div");a.style.fontSize="12px",a.style.margin="0 0 12px";const i=[];p&&(p.date&&i.push(`Date: ${p.date}`),p.timeSlot&&i.push(`Time: ${p.timeSlot}`),p.subjectName&&i.push(`Subject: ${p.subjectName}`),p.teacherName&&i.push(`Teacher: ${p.teacherName}`)),a.textContent=i.join(" ‚Ä¢ "),s.appendChild(a);const r=document.createElement("table");r.style.width="100%",r.style.borderCollapse="collapse",r.style.fontSize="11px";const c=document.createElement("thead"),d=document.createElement("tr");["Roll Number","Student ID","Name","Father's Name","Status","Check-in Time"].forEach(g=>{const h=document.createElement("th");h.textContent=g,h.style.border="1px solid #333",h.style.padding="6px",h.style.textAlign="left",h.style.background="#f0f0f0",d.appendChild(h)}),c.appendChild(d),r.appendChild(c);const b=document.createElement("tbody");e.forEach(g=>{const h=document.createElement("tr"),E=!!N[g.id];[String(J(g.id)),String(g.id),String(g.name||""),String(g.father||""),E?"Present":"Absent",v[g.id]||"-"].forEach((L,W)=>{const x=document.createElement("td");x.textContent=L,x.style.border="1px solid #333",x.style.padding="6px",x.style.verticalAlign="top",W===4&&(x.style.fontWeight="700",x.style.color=E?"#0a5a0a":"#b00020",x.style.textAlign="left"),h.appendChild(x)}),E&&(h.style.background="#dff0d8"),b.appendChild(h)}),r.appendChild(b),s.appendChild(r);const l=`attendance${p!=null&&p.subjectCode?`_${p.subjectCode}`:""}_${t}.pdf`,u={margin:[10,10,10,10],filename:l,image:{type:"jpeg",quality:.98},html2canvas:{scale:2,useCORS:!0},jsPDF:{unit:"mm",format:"a4",orientation:"landscape"}};await html2pdf().from(s).set(u).save()}catch{try{Ae()}catch{}}}function Ae(){const e=_e(),t=new Date().toLocaleString();let n="";n+="<!DOCTYPE html><html><head><title>Attendance Print</title>",n+='<meta name="viewport" content="width=device-width, initial-scale=1">',n+="<style>html,body{background:#fff !important}body{font-family:Arial,Helvetica,sans-serif;padding:20px;color:#000}h1{font-size:20px;margin:0 0 10px} h2{font-size:14px;margin:0 0 20px;color:#333}table{width:100%;border-collapse:collapse;table-layout:auto}thead{display:table-header-group} tfoot{display:table-footer-group}tr, td, th{page-break-inside:avoid; break-inside:avoid}th,td{border:1px solid #333;padding:8px;text-align:left;font-size:12px;vertical-align:top}th{background:#f0f0f0}tr.present td{background:#eefbea}@page { size: A4 landscape; margin: 10mm; }@media print { body{ -webkit-print-color-adjust: exact; print-color-adjust: exact; } }</style></head><body>",n+="<h1>GNDU Attendance</h1>",n+=`<h2>Printed: ${t}</h2>`,n+="<table><thead><tr><th>Roll Number</th><th>Student ID</th><th>Name</th><th>Father\\'s Name</th><th>Status</th><th>Check-in Time</th></tr></thead><tbody>",e.forEach(i=>{const r=N[i.id]?"Present":"Absent",c=v[i.id]||"-";n+='<tr class="'+(N[i.id]?"present":"")+`"><td>${J(i.id)}</td><td>${String(i.id)}</td><td>${String(i.name||"")}</td><td>${String(i.father||"")}</td><td>${r}</td><td>${c}</td></tr>`}),n+="</tbody></table>",n+='<script>window.addEventListener("afterprint", function(){ setTimeout(function(){ window.close && window.close(); }, 0); });<\/script>',n+="</body></html>";const s=document.createElement("iframe");s.style.position="fixed",s.style.right="0",s.style.bottom="0",s.style.width="0",s.style.height="0",s.style.border="0",s.setAttribute("aria-hidden","true");const o=()=>{try{document.body.removeChild(s)}catch{}},a=()=>{try{const i=s.contentWindow||s;setTimeout(()=>{try{i.focus()}catch{}try{i.print()}catch{}setTimeout(o,3e3)},500)}catch{o()}};if(s.onload=a,"srcdoc"in s)s.srcdoc=n,document.body.appendChild(s);else{document.body.appendChild(s);const i=s.contentWindow?s.contentWindow.document:s.document;i.open(),i.write(n),i.close(),setTimeout(a,700)}}window.testExpiredSession=function(){const e="TEST_EXPIRED_"+Date.now(),t={sessionId:e,date:new Date().toLocaleDateString("en-GB"),subjectName:"Test Session",teacherName:"Test Teacher",timeSlot:new Date().toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"}),secretCode:"TEST123",expiryTime:new Date(Date.now()-1e3).toISOString(),isExpired:!0};localStorage.setItem("attendanceSession_"+e,JSON.stringify(t));const n=window.location.href.split("?")[0]+"?session="+e;confirm("Open test expired session in new tab?")&&window.open(n,"_blank")};function Et(){try{const e=document.querySelector(".table-container");if(!e){alert("Table not found to print.");return}const t=document.body.getAttribute("data-theme")||"",n=e.innerHTML,s=window.open("","_blank");if(!s)return;const o=`<!DOCTYPE html>
    <html>
      <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>Print - Original Table</title>
        <link rel="stylesheet" href="styles.css" />
        <style>
          /* Ensure print-friendly spacing */
          body { background: white !important; padding: 20px; }
          .table-container { box-shadow: none; border-radius: 0; }
          .scroll-hint, .controls, .stats, .link-section, .current-class-info { display: none !important; }
          @media print {
            .table-container { overflow: visible !important; }
          }
        </style>
      </head>
      <body ${t?`data-theme="${t}"`:""}>
        <div class="table-container">${n}</div>
        <script>
          setTimeout(function(){ window.print(); window.close(); }, 300);
        <\/script>
      </body>
    </html>`;s.document.open(),s.document.write(o),s.document.close()}catch{alert("Unable to print the table.")}}window.exportToExcel=wt;window.printAttendance=Ae;window.printTableAsIs=Et;async function we(e){let t=JSON.parse(localStorage.getItem("attendanceSession_"+e)||"null");if(t&&t.sessionId===e){if(z(t))if(D)try{const n=await S.collection("attendanceSessions").doc(e).get();if(n.exists){const s=n.data();if(s.expiryTime&&typeof s.expiryTime.toDate=="function"?s.expiryTime=s.expiryTime.toDate().toISOString():s.expiryTime&&typeof s.expiryTime.seconds=="number"&&(s.expiryTime=new Date(s.expiryTime.seconds*1e3).toISOString()),localStorage.setItem("attendanceSession_"+e,JSON.stringify(s)),z(s)){ce();return}else{t=s,De(t);return}}else{he("Session not found or has expired");return}}catch{ce();return}else{ce();return}if(!(!t.expiryTime&&D)){De(t),D&&wn(e);return}}if(D)try{if(console.log("Loading session from Firebase with caching"),t=await Lt(e),console.log("Session loaded:",t?"Success":"Failed"),t){if(z(t)){ce();return}De(t)}else he("Session not found or has expired")}catch(n){console.error("Error loading session:",n),he("Unable to load session. Please check your connection and try again.")}else try{await Xe(),await we(e)}catch{he("Unable to connect to the server. Please check your internet connection and refresh the page.")}}async function wn(e){try{const t=await S.collection("attendanceSessions").doc(e).get();if(t.exists){let n=t.data();n.expiryTime&&typeof n.expiryTime.toDate=="function"?n.expiryTime=n.expiryTime.toDate().toISOString():n.expiryTime&&typeof n.expiryTime.seconds=="number"&&(n.expiryTime=new Date(n.expiryTime.seconds*1e3).toISOString()),localStorage.setItem("attendanceSession_"+e,JSON.stringify(n))}}catch{}}function he(e){const t=document.getElementById("checkinMessage");if(t){j(t,"error",`‚ùå ${e}`),t.scrollIntoView({behavior:"smooth",block:"center"});const n=document.getElementById("submitBtn");n&&(n.disabled=!1,n.textContent="Mark Me Present");const s=document.getElementById("studentCheckinForm");s&&s.querySelectorAll("input").forEach(o=>o.disabled=!1)}else alert(e)}function ce(){const e=document.getElementById("loginScreen"),t=document.getElementById("teacherDashboard"),n=document.getElementById("studentCheckin");e&&(e.style.display="none"),t&&(t.style.display="none"),n&&(n.style.display="block",n.innerHTML=`
      <div class="checkin-header">
        <h2>‚è∞ Attendance Over</h2>
        <p>GNDU Attendance System</p>
      </div>
      <div style="text-align: center; padding: 40px 20px; max-width: 400px; margin: 0 auto;">
        <div style="font-size: 64px; margin-bottom: 20px;">‚è∞</div>
        <h2 style="color: #e74c3c; margin-bottom: 15px;">Attendance is Over</h2>
        <p style="font-size: 16px; color: #666; margin-bottom: 20px;">
          This attendance session has expired and is no longer accepting responses.
        </p>
        <p style="font-size: 14px; color: #999;">
          Please contact your teacher if you need to mark attendance for this session.
        </p>
      </div>
    `)}async function De(e){if(z(e)){const d=document.getElementById("loginScreen"),m=document.getElementById("teacherDashboard"),b=document.getElementById("studentCheckin");if(d&&(d.style.display="none"),m&&(m.style.display="none"),b){b.style.display="block";const f=document.querySelector(".checkin-form");f&&(f.innerHTML=`
          <div style="text-align: center; padding: 40px 20px;">
            <div style="font-size: 48px; margin-bottom: 20px;">‚è∞</div>
            <h2 style="color: #e74c3c; margin-bottom: 15px;">Attendance is Over</h2>
            <p style="font-size: 16px; color: #666; margin-bottom: 20px;">
              This attendance session has expired and is no longer accepting responses.
            </p>
            <p style="font-size: 14px; color: #999;">
              Please contact your teacher if you need to mark attendance for this session.
            </p>
          </div>
        `)}return}window.sessionSecretCode=e.secretCode||"";const t=document.getElementById("loginScreen"),n=document.getElementById("teacherDashboard");t&&(t.style.display="none"),n&&(n.style.display="none");const s=document.getElementById("studentCheckin");if(s){s.style.display="block";const d=document.querySelector(".checkin-form");d&&(d.onsubmit=function(m){return m.preventDefault(),ke(),!1})}const o=document.getElementById("checkinClassInfo");if(o){fe(o);const d=document.createElement("h3");d.textContent=e.subjectName||"No Subject";const m=document.createElement("p");m.textContent=`üìÖ ${e.date||"No date"} ‚Ä¢ ‚è∞ ${e.timeSlot||"No time slot"}`;const b=document.createElement("p");b.textContent=`üë®‚Äçüè´ ${e.teacherName||"Teacher"}`,o.appendChild(d),o.appendChild(m),o.appendChild(b)}const a=document.getElementById("studentCheckinForm"),i=document.getElementById("submitBtn"),r=document.getElementById("checkinMessage");a&&a.reset(),i&&(i.disabled=!0,i.textContent="Checking location..."),window.locationVerified=!1,window.locationDistance=0,r&&(r.innerHTML=""),i&&(i.disabled=!0,i.textContent="Checking location...",H("üìç Automatically verifying your location...","info"),async function(){try{const d=await St();if(window.locationVerified=d.success,window.locationDistance=d.distance||0,window.locationVerified)i.disabled=!1,i.textContent="Mark Me Present",i.onclick=function(m){m.preventDefault(),ke()},H("‚úÖ Location verified! You can now mark attendance.","allowed");else{i.disabled=!0,i.textContent="Location Verification Failed";const m=window.locationDistance>=1e3?`${(window.locationDistance/1e3).toFixed(1)} km away`:`${Math.round(window.locationDistance)} meters away`;H(`‚ùå You are ${m} from GNDU`,"denied"),i.onclick=async function(b){b.preventDefault(),location.reload()}}}catch(d){console.error("Location check failed:",d),i.disabled=!0,i.textContent="Location Error - Try Again",H("‚ùå Location verification failed. Click to retry.","denied"),i.onclick=async function(m){m.preventDefault(),location.reload()}}}());const c=a==null?void 0:a.querySelector("input");c&&c.focus()}async function ke(){var g,h,E,_,L,W,x;const e=new URLSearchParams(window.location.search).get("session")||p&&p.sessionId||C||"",t=K&&K.currentUser,n=(h=(g=document.getElementById("secretCodeInput"))==null?void 0:g.value)==null?void 0:h.trim().toUpperCase(),s=(_=(E=document.getElementById("studentId"))==null?void 0:E.value)==null?void 0:_.trim(),o=(W=(L=document.getElementById("studentName"))==null?void 0:L.value)==null?void 0:W.trim(),a=document.getElementById("studentCheckinForm"),i=document.getElementById("submitBtn"),r=document.getElementById("checkinMessage");function c(y){r&&j(r,"error",y)}function d(y){return(y||"").toString().trim().replace(/\s+/g," ").toUpperCase()}function m(){}const b=parseInt(s,10);let l=(typeof A<"u"&&Array.isArray(A)?A:Array.isArray(window.students)?window.students:[]).length;if(!l&&window.idByRoll&&(l=Object.keys(window.idByRoll).length),!l){c("Student list not loaded yet. Please refresh the page and try again."),i&&(i.disabled=!1,i.textContent="Mark Me Present"),a&&a.querySelectorAll("input").forEach(y=>y.disabled=!1);return}if(!Number.isInteger(b)||b<1||b>l){c(`Roll Number must be a number between 1 and ${l} (inclusive).`),i&&(i.disabled=!1,i.textContent="Mark Me Present"),a&&a.querySelectorAll("input").forEach(y=>y.disabled=!1);return}let u;try{const y=localStorage.getItem("attendanceSession_"+e);if(y){if(u=JSON.parse(y),!u.secretCode){const R=await S.collection("attendanceSessions").doc(e).get();R.exists&&(u=R.data(),localStorage.setItem("attendanceSession_"+e,JSON.stringify(u)))}}else{const R=await S.collection("attendanceSessions").doc(e).get();if(!R.exists)throw new Error("Session not found in database");u=R.data(),localStorage.setItem("attendanceSession_"+e,JSON.stringify(u))}if(!u)throw new Error("Failed to load session data");if(!u.secretCode)throw new Error("This session is not properly configured. Please contact your teacher.")}catch{c("Session configuration error. Please contact your teacher or try again later."),i&&(i.disabled=!1,i.textContent="Mark Me Present"),a&&a.querySelectorAll("input").forEach(R=>R.disabled=!1);return}if(n!==u.secretCode.toUpperCase()){c("‚ùå Incorrect secret code. Please check with your teacher and try again."),i&&(i.disabled=!1,i.textContent="Mark Me Present"),a&&a.querySelectorAll("input").forEach(y=>y.disabled=!1);return}if(!window.locationVerified){const y=window.locationDistance||0,R=y>=1e3?`${(y/1e3).toFixed(1)} km away`:`${Math.round(y)} meters away`;c(`‚ùå You must be inside the university campus to mark attendance. You are ${R} from GNDU.`),i&&(i.disabled=!1,i.textContent="Mark Me Present"),a&&a.querySelectorAll("input").forEach(I=>I.disabled=!1);return}i&&(i.disabled=!0,i.textContent="Submitting..."),a&&a.querySelectorAll("input").forEach(y=>y.disabled=!0);try{let y=(x=window.idByRoll)==null?void 0:x[b];!y&&Array.isArray(A)&&A[b-1]&&(y=String(A[b-1].id));const I=(Array.isArray(A)?A:Array.isArray(window.students)?window.students:[]).find(w=>{var k;return((k=w==null?void 0:w.id)==null?void 0:k.toString())===String(y)}),ne=d(o);if(!I){c("‚ùå Invalid Roll Number. Please check your roll number and try again."),i&&(i.disabled=!1,i.textContent="Mark Me Present"),a&&a.querySelectorAll("input").forEach(w=>w.disabled=!1);return}const oe=d(I.name);if(ne!==oe){c("‚ùå Name does not match the roll number. Please ensure both your name and roll number are correct."),i&&(i.disabled=!1,i.textContent="Mark Me Present"),a&&a.querySelectorAll("input").forEach(w=>w.disabled=!1);return}const M=`attendance_${e}_${y}`,je=localStorage.getItem(M)==="true";let se={};try{se=JSON.parse(localStorage.getItem(M)||"{}")}catch{se={}}if(!t){const w=`device_${e}`;if(localStorage.getItem(w)){c("‚ùå Your device can mark attendance only one time per session. If you need to update your attendance, please contact your teacher."),a&&a.querySelectorAll("input").forEach(B=>B.disabled=!0),i&&(i.disabled=!0,i.textContent="Limited to One Attendance");return}}try{const[w,k]=await Promise.all([S.collection("attendanceSessions").doc(e).get(),S.collection("attendanceSessions").doc(e).collection("attendance").doc(y).get()]),B=w.exists?w.data():{},Ne=B.attendance&&B.attendance[y]===!0,ve=k.exists;if(je||Ne||ve){c("‚úÖ Your attendance is already marked as present for this session."),a&&a.querySelectorAll("input").forEach(It=>It.disabled=!0),i&&(i.disabled=!0,i.textContent="Already Marked Present"),je||localStorage.setItem(M,"true");return}}catch{}if(JSON.parse(localStorage.getItem("attendance_"+e)||"{}")[y]){c("‚úÖ Your attendance is already marked as present for this session."),i&&(i.disabled=!0,i.textContent="Already Marked Present"),a&&a.querySelectorAll("input").forEach(w=>w.disabled=!0),localStorage.setItem(M,"true");return}const Oe=new Date,Q={studentId:I.id.toString(),studentName:I.name,name:I.name,father:I.father||"N/A",time:Oe.toLocaleTimeString(),timestamp:firebase.firestore.FieldValue.serverTimestamp(),localTimestamp:Oe.toISOString(),secretCode:n,status:"present",locationVerified:!0,sessionId:e,latitude:null,longitude:null};if(navigator.geolocation)try{const w=await new Promise((k,B)=>{navigator.geolocation.getCurrentPosition(k,B,{enableHighAccuracy:!0,timeout:5e3,maximumAge:0})});w!=null&&w.coords&&(Q.latitude=w.coords.latitude,Q.longitude=w.coords.longitude,Q.locationAccuracy=w.coords.accuracy)}catch(w){console.warn("Geolocation error (attendance will still be recorded):",w)}r&&j(r,"info","Submitting your attendance, please wait...");try{if(D&&typeof S<"u"){const w=S.batch(),k=S.collection("attendanceSessions").doc(e),B={[`attendance.${y}`]:!0,[`attendanceTime.${y}`]:firebase.firestore.FieldValue.serverTimestamp(),[`attendanceRecords.${y}`]:Q,lastUpdated:firebase.firestore.FieldValue.serverTimestamp()};w.update(k,B);const Ne=k.collection("attendance").doc(y);if(w.set(Ne,{...Q,timestamp:firebase.firestore.FieldValue.serverTimestamp()},{merge:!0}),await w.commit(),localStorage.setItem(M,"true"),!t){const ve=`device_${e}`;localStorage.setItem(ve,new Date().toISOString())}r&&j(r,"success",`‚úÖ Attendance recorded successfully! ${I.name} (${I.id}) is marked present.`)}else{const w="local_"+Date.now();se[I.id]={...Q,id:w,synced:!1,timestamp:new Date().toISOString()},localStorage.setItem(M,JSON.stringify(se)),r&&j(r,"success",`‚úÖ Attendance recorded locally! ${I.name} (${I.id}) is marked present.`)}a&&a.reset(),i&&(i.disabled=!0,i.textContent="Attendance Recorded"),setTimeout(()=>{const w=document.getElementById("checkinMessage");w&&fe(w)},5e3)}catch{const k="local_"+Date.now();if(se[I.id]={...Q,id:k,synced:!1,timestamp:new Date().toISOString()},localStorage.setItem(M,JSON.stringify(se)),!t){const B=`device_${e}`;localStorage.setItem(B,new Date().toISOString())}if(!t){const B=`device_${e}`;localStorage.setItem(B,new Date().toISOString())}r&&j(r,"warning","‚ö†Ô∏è Attendance saved offline. It will sync when online."),i&&(i.disabled=!0,i.textContent="Saved Offline"),p&&p.sessionId===e&&(N[I.id]=!0,v[I.id]=new Date,Y()),a&&a.querySelectorAll("input").forEach(B=>B.disabled=!0)}}catch(y){r&&j(r,"error",`‚ùå An error occurred while processing your request. Please try again later. ${y.message?y.message:""}`),i&&(i.disabled=!1,i.textContent="Try Again"),a&&a.querySelectorAll("input").forEach(R=>R.disabled=!1)}}window.submitAttendance=ke;window.copyLink=dn;window.shareWhatsApp=un;window.handleLogout=Ue;window.logout=Ue;window.handleLogin=handleLogin;window.handleGuestLogin=ot;window.showTab=rt;window.expireSessionManually=cn;window.loadSubjectResources=mt;window.showResourceTab=dt;window.addResource=gt;window.editDocument=Wt;window.openDocument=zt;window.viewPDF=Yt;window.showGuestTab=ct;window.loadGuestAttendance=me;window.loadGuestSubjectResources=ft;window.showGuestResourceTab=ut;
